(window.webpackJsonp=window.webpackJsonp||[]).push([[105],{435:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"rabbitmq-可靠性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#rabbitmq-可靠性"}},[s._v("#")]),s._v(" RabbitMQ 可靠性")]),s._v(" "),t("p",[s._v("确保MQ消息的可靠性，即：消息应该至少被消费者处理1次\n那么问题来了：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("我们该如何确保MQ消息的可靠性")]),s._v("？")]),s._v(" "),t("li",[t("strong",[s._v("如果真的发送失败，有没有其它的兜底方案？")])])]),s._v(" "),t("p",[s._v("消息从发送者发送消息，到消费者处理消息，需要经过的流程是这样的：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102341532.png",alt:"image-20231018102341532"}})]),s._v(" "),t("p",[s._v("消息从生产者到消费者的每一步都可能导致消息丢失：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("发送消息时丢失：")]),s._v(" "),t("ul",[t("li",[s._v("生产者发送消息时"),t("strong",[s._v("连接MQ失败")])]),s._v(" "),t("li",[s._v("生产者发送消息到达MQ后"),t("strong",[s._v("未找到"),t("code",[s._v("Exchange")])])]),s._v(" "),t("li",[s._v("生产者发送消息到达"),t("strong",[s._v("MQ的"),t("code",[s._v("Exchange")]),s._v("后，未找到合适的"),t("code",[s._v("Queue")])]),s._v("   （上面这两种基本上是代码层面声明错了，所以一般不需要配置，因为开发时就能找出）")]),s._v(" "),t("li",[s._v("消息到达MQ后，处理消息的进程发生异常")])])]),s._v(" "),t("li",[t("p",[s._v("MQ导致消息丢失：")]),s._v(" "),t("ul",[t("li",[s._v("消息到达MQ，保存到队列后，尚未消费就突然宕机")])])]),s._v(" "),t("li",[t("p",[s._v("消费者处理消息时：")]),s._v(" "),t("ul",[t("li",[s._v("消息接收后尚未处理突然宕机")]),s._v(" "),t("li",[t("strong",[s._v("消息接收后处理过程中抛出异常")])])])]),s._v(" "),t("li",[t("p",[s._v("确保生产者一定把消息发送到MQ")])]),s._v(" "),t("li",[t("p",[s._v("确保MQ不会将消息弄丢")])]),s._v(" "),t("li",[t("p",[s._v("确保消费者一定要处理消息")])])]),s._v(" "),t("h2",{attrs:{id:"消息发送方处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#消息发送方处理"}},[s._v("#")]),s._v(" 消息发送方处理")]),s._v(" "),t("h3",{attrs:{id:"确保连接成功"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#确保连接成功"}},[s._v("#")]),s._v(" 确保连接成功")]),s._v(" "),t("p",[s._v("多次重试连接")]),s._v(" "),t("p",[s._v("为了解决这个问题，SpringAMQP提供的消息发送时的重试机制。即：当"),t("code",[s._v("RabbitTemplate")]),s._v("与MQ连接超时后，多次重试。")]),s._v(" "),t("p",[s._v("修改"),t("code",[s._v("publisher")]),s._v("模块的"),t("code",[s._v("application.yaml")]),s._v("文件，添加下面的内容：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("connection-timeout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1s "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置MQ的连接超时时间")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("retry")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启超时重试机制")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initial-interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1000ms "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 失败后的初始等待时间")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("multiplier")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 失败后下次的等待时长倍数，下次等待时长 = initial-interval * multiplier")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max-attempts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最大重试次数")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("当网络不稳定的时候，利用重试机制可以有效提高消息发送的成功率。不过SpringAMQP提供的重试机制是"),t("strong",[s._v("阻塞式")]),s._v("的重试，也就是说多次重试等待的过程中，当前线程是被阻塞的。\n如果对于业务性能有要求，建议禁用重试机制。如果一定要使用，请合理配置等待时长和重试次数，当然也可以考虑使用异步线程来执行发送消息的代码。")]),s._v(" "),t("h3",{attrs:{id:"消息发送后的确认"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#消息发送后的确认"}},[s._v("#")]),s._v(" 消息发送后的确认")]),s._v(" "),t("p",[s._v("确认消息发送到了RabbitMQ")]),s._v(" "),t("p",[s._v("一般情况下，只要生产者与MQ之间的网路连接顺畅，基本不会出现发送消息丢失的情况，因此大多数情况下我们无需考虑这种问题。\n不过，在少数情况下，也会出现消息发送到MQ之后丢失的现象，比如：")]),s._v(" "),t("ul",[t("li",[s._v("MQ内部处理消息的进程发生了异常")]),s._v(" "),t("li",[t("strong",[s._v("生产者发送消息到达MQ后未找到"),t("code",[s._v("Exchange")])])]),s._v(" "),t("li",[t("strong",[s._v("生产者发送消息到达MQ的"),t("code",[s._v("Exchange")]),s._v("后，未找到合适的"),t("code",[s._v("Queue")]),s._v("，因此无法路由")]),s._v("   （以上两种都是代码层面的）")])]),s._v(" "),t("p",[s._v("针对上述情况，RabbitMQ提供了生产者"),t("strong",[s._v("消息确认机制")]),s._v("，"),t("strong",[s._v("包括"),t("code",[s._v("Publisher Confirm")]),s._v("和"),t("code",[s._v("Publisher Return")]),s._v("两种。"),t("strong",[s._v("在开启确认机制的情况下，当生产者发送消息给MQ后，MQ会根据消息处理的情况返回不同的")]),s._v("回执")]),s._v("。\n具体如图所示：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102501263.png",alt:"image-20231018102426496"}})]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("当消息投递到MQ，但是路由失败时")]),s._v("，"),t("strong",[s._v("通过Publisher Return返回异常信息")]),s._v("，同时返回ack的确认信息，代表投递成功")]),s._v(" "),t("li",[t("strong",[s._v("临时消息")]),s._v("投递到了MQ，并且入队成功，返回ACK，告知投递成功")]),s._v(" "),t("li",[t("strong",[s._v("持久消息")]),s._v("投递到了MQ，并且入队完成持久化，返回ACK ，告知投递成功")]),s._v(" "),t("li",[s._v("其它情况都会返回NACK，告知投递失败")])]),s._v(" "),t("p",[t("strong",[s._v("路由失败，是通过Publisher Return返回异常信息")])]),s._v(" "),t("p",[t("strong",[s._v("其中"),t("code",[s._v("ack")]),s._v("和"),t("code",[s._v("nack")]),s._v("属于Publisher Confirm机制，")]),t("code",[s._v("ack")]),s._v("是投递成功；"),t("code",[s._v("nack")]),s._v("是投递失败。"),t("strong",[s._v("而"),t("code",[s._v("return")]),s._v("则属于Publisher Return机制。")]),s._v("\n默认两种机制都是关闭状态，需要通过配置文件来开启。")]),s._v(" "),t("p",[s._v("在publisher模块的"),t("code",[s._v("application.yaml")]),s._v("中添加配置：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("publisher-confirm-type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" correlated "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启publisher confirm机制，并设置confirm类型")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("publisher-returns")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启publisher return机制")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("这里"),t("code",[s._v("publisher-confirm-type")]),s._v("有"),t("strong",[s._v("三种模式")]),s._v("可选：")]),s._v(" "),t("ul",[t("li",[t("strong",[t("code",[s._v("none")]),s._v("：关闭confirm机制")])]),s._v(" "),t("li",[t("strong",[t("code",[s._v("simple")]),s._v("：同步阻塞等待MQ的回执")])]),s._v(" "),t("li",[t("strong",[t("code",[s._v("correlated")]),s._v("：MQ异步回调返回回执")])])]),s._v(" "),t("p",[t("strong",[s._v("一般我们推荐使用"),t("code",[s._v("correlated")]),s._v("，回调机制。")])]),s._v(" "),t("h4",{attrs:{id:"publish-return-的实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#publish-return-的实现"}},[s._v("#")]),s._v(" publish return 的实现")]),s._v(" "),t("p",[s._v("在回顾一下，什么时候是publish return,找不到队列，路由失败的时候，所以这个其实不太重要")]),s._v(" "),t("p",[s._v("**每个"),t("code",[s._v("RabbitTemplate")]),s._v("只能配置一个"),t("code",[s._v("ReturnCallback")]),s._v("，**因此我们可以在配置类中统一设置。我们在publisher模块定义一个配置类：\n内容如下：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("itheima"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("publisher"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("lombok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AllArgsConstructor")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("lombok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("extern"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("slf4j"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Slf4j")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ReturnedMessage")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rabbit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Configuration")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("javax"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PostConstruct")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Slf4j")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@AllArgsConstructor")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Configuration")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MqConfig")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate")]),s._v(" rabbitTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@PostConstruct")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("init")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        rabbitTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setReturnsCallback")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RabbitTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("ReturnsCallback")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("returnedMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ReturnedMessage")]),s._v(" returned"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"触发return callback,"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"exchange: {}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" returned"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getExchange")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"routingKey: {}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" returned"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getRoutingKey")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message: {}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" returned"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"replyCode: {}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" returned"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getReplyCode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"replyText: {}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" returned"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getReplyText")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("h4",{attrs:{id:"confirm机制的实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#confirm机制的实现"}},[s._v("#")]),s._v(" confirm机制的实现")]),s._v(" "),t("p",[s._v("由于每个消息发送时的处理逻辑不一定相同，因此"),t("strong",[s._v("ConfirmCallback需要在每次发消息时定义")]),s._v("。具体来说，是在"),t("strong",[s._v("调用RabbitTemplate中的convertAndSend方法时，多传递一个参数：")]),s._v(" "),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102603396.png",alt:"image-20231018102501263"}}),s._v("\n这里的CorrelationData中包含两个核心的东西：")]),s._v(" "),t("ul",[t("li",[t("strong",[t("code",[s._v("id")]),s._v("：消息的唯一标示，MQ对不同的消息的回执以此做判断，避免混淆")])]),s._v(" "),t("li",[t("strong",[t("code",[s._v("SettableListenableFuture")]),s._v("：回执结果的Future对象")])])]),s._v(" "),t("p",[s._v("将来MQ的回执就会通过这个"),t("code",[s._v("Future")]),s._v("来返回，我们可以提前给"),t("code",[s._v("CorrelationData")]),s._v("中的"),t("code",[s._v("Future")]),s._v("添加回调函数来处理消息回执：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102522381.png",alt:"image-20231018102522381"}})]),s._v(" "),t("p",[s._v("我们新建一个测试，向系统自带的交换机发送消息，并且添加"),t("code",[s._v("ConfirmCallback")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("testPublisherConfirm")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.创建CorrelationData")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CorrelationData")]),s._v(" cd "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CorrelationData")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2.给Future添加ConfirmCallback")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// future对象")]),s._v("\n    cd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getFuture")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("addCallback")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ListenableFutureCallback")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CorrelationData"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Confirm")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("onFailure")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Throwable")]),s._v(" ex"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2.1.Future发生异常时的处理逻辑，基本不会触发")]),s._v("\n            log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"send message fail"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ex"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("onSuccess")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CorrelationData"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Confirm")]),s._v(" result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2.2.Future接收到回执的处理逻辑，参数中的result就是回执内容")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("isAck")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// result.isAck()，boolean类型，true代表ack回执，false 代表 nack回执")]),s._v("\n                log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("debug")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"发送消息成功，收到 ack!"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// result.getReason()，String类型，返回nack时的异常描述")]),s._v("\n                log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"发送消息失败，收到 nack, reason : {}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" result"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getReason")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//多传一个CorrelationData参数，上面就在构造这个参数")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3.发送消息")]),s._v("\n    rabbitTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hmall.direct"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"q"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br")])]),t("p",[s._v("执行结果如下：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102426496.png",alt:"image-20231018102543966"}}),s._v("\n可以看到，由于传递的"),t("code",[s._v("RoutingKey")]),s._v("是错误的，"),t("strong",[s._v("路由失败后，触发了"),t("code",[s._v("return callback")]),s._v("，同时也收到了ack。")]),s._v("\n当我们修改为正确的"),t("code",[s._v("RoutingKey")]),s._v("以后，就不会触发"),t("code",[s._v("return callback")]),s._v("了，只收到ack。\n而如果连交换机都是错误的，则只会收到nack。")]),s._v(" "),t("p",[s._v("总结：")]),s._v(" "),t("p",[s._v("**开启生产者确认比较消耗MQ性能，一般不建议开启。**而且大家思考一下触发确认的几种情况：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("路由失败：一般是因为RoutingKey错误导致，往往是编程导致")])]),s._v(" "),t("li",[t("strong",[s._v("交换机名称错误：同样是编程错误导致")])]),s._v(" "),t("li",[s._v("MQ内部故障：这种需要处理，但概率往往较低。"),t("strong",[s._v("因此只有对消息可靠性要求非常高的业务才需要开启，而且仅仅需要开启ConfirmCallback处理nack就可以了。")])])]),s._v(" "),t("h2",{attrs:{id:"mq消息队列的处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mq消息队列的处理"}},[s._v("#")]),s._v(" mq消息队列的处理")]),s._v(" "),t("p",[s._v("消息到达MQ以后，如果MQ不能及时保存，也会导致消息丢失，所以MQ的可靠性也非常重要。")]),s._v(" "),t("h3",{attrs:{id:"数据持久化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据持久化"}},[s._v("#")]),s._v(" 数据持久化")]),s._v(" "),t("p",[s._v("为了提升性能，默认情况下MQ的数据都是在内存存储的临时数据，重启后就会消失。为了保证数据的可靠性，必须配置数据持久化，包括：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("交换机持久化")])]),s._v(" "),t("li",[t("strong",[s._v("队列持久化")])]),s._v(" "),t("li",[t("strong",[s._v("消息持久化")])])]),s._v(" "),t("p",[s._v("我们以控制台界面为例来说明。")]),s._v(" "),t("h3",{attrs:{id:"交换机持久化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#交换机持久化"}},[s._v("#")]),s._v(" 交换机持久化")]),s._v(" "),t("p",[s._v("在控制台的"),t("code",[s._v("Exchanges")]),s._v("页面，添加交换机时可以配置交换机的"),t("code",[s._v("Durability")]),s._v("参数：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102635278.png",alt:"image-20231018102603396"}})]),s._v(" "),t("p",[t("strong",[s._v("设置为"),t("code",[s._v("Durable")]),s._v("就是持久化模式，"),t("code",[s._v("Transient")]),s._v("就是临时模式。")])]),s._v(" "),t("h3",{attrs:{id:"队列持久化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#队列持久化"}},[s._v("#")]),s._v(" 队列持久化")]),s._v(" "),t("p",[s._v("在控制台的Queues页面，添加队列时，同样可以配置队列的"),t("code",[s._v("Durability")]),s._v("参数：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102619134.png",alt:"image-20231018102619134"}})]),s._v(" "),t("h3",{attrs:{id:"消息持久化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#消息持久化"}},[s._v("#")]),s._v(" 消息持久化")]),s._v(" "),t("p",[s._v("在控制台发送消息的时候，可以添加很多参数，而消息的持久化是要配置一个"),t("code",[s._v("properties")]),s._v("：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102654732.png",alt:"image-20231018102635278"}})]),s._v(" "),t("p",[t("strong",[s._v("说明")]),s._v("：")]),s._v(" "),t("p",[s._v("在开启持久化机制以后，如果同时"),t("strong",[s._v("还开启了生产者确认，那么MQ会在消息持久化以后才发送ACK回执，进一步确保消息的可靠性。"),t("strong",[s._v("不过出于性能考虑，为了减少IO次数")]),s._v("，发送到MQ的消息并不是逐条持久化到数据库的，而是每隔一段时间批量持久化。一般间隔在100毫秒左右，这就会导致ACK有一定的延迟，因此建议生产者确认全部采用异步方式。")])]),s._v(" "),t("h3",{attrs:{id:"lazyqueue"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lazyqueue"}},[s._v("#")]),s._v(" LazyQueue")]),s._v(" "),t("p",[s._v("**在默认情况下，RabbitMQ会将接收到的信息保存在内存中以降低消息收发的延迟。**但在某些特殊情况下，这会导致消息积压，比如：")]),s._v(" "),t("ul",[t("li",[s._v("消费者宕机或出现网络故障")]),s._v(" "),t("li",[s._v("消息发送量激增，超过了消费者处理速度")]),s._v(" "),t("li",[s._v("消费者处理业务发生阻塞")])]),s._v(" "),t("p",[s._v("一旦出现消息堆积问题，"),t("strong",[s._v("RabbitMQ的内存占用就会越来越高，直到触发内存预警上限。此时RabbitMQ会将内存消息刷到磁盘上，这个行为成为"),t("code",[s._v("PageOut")]),s._v(". "),t("code",[s._v("PageOut")]),s._v("会耗费一段时间，并且会阻塞队列进程。因此在这个过程中RabbitMQ不会再处理新的消息，生产者的所有请求都会被阻塞。")])]),s._v(" "),t("p",[s._v("为了解决这个问题，从RabbitMQ的3.6.0版本开始，就增加了Lazy Queues的模式，也就是惰性队列。惰性队列的特征如下：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("接收到消息后直接存入磁盘而非内存")])]),s._v(" "),t("li",[t("strong",[s._v("消费者要消费消息时才会从磁盘中读取并加载到内存（也就是懒加载）")])]),s._v(" "),t("li",[t("strong",[s._v("支持数百万条的消息存储")])])]),s._v(" "),t("p",[s._v("而在3.12版本之后，"),t("strong",[s._v("LazyQueue已经成为所有队列的默认格式。因此官方推荐升级MQ为3.12版本或者所有队列都设置为LazyQueue模式。")])]),s._v(" "),t("h4",{attrs:{id:"控制台配置lazy模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#控制台配置lazy模式"}},[s._v("#")]),s._v(" 控制台配置Lazy模式")]),s._v(" "),t("p",[s._v("在添加队列的时候，添加"),t("code",[s._v("x-queue-mod=lazy")]),s._v("参数即可设置队列为Lazy模式：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102832421.png",alt:"image-20231018102654732"}})]),s._v(" "),t("h4",{attrs:{id:"代码配置lazy模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#代码配置lazy模式"}},[s._v("#")]),s._v(" 代码配置Lazy模式")]),s._v(" "),t("p",[s._v("在利用SpringAMQP声明队列的时候,"),t("code",[s._v("durable")]),s._v("持久化，"),t("code",[s._v(",lazy()")]),s._v("设置为LazyQueue")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("lazyQueue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("QueueBuilder")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("durable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lazy.queue"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("lazy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 开启Lazy模式")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("build")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("这里是通过"),t("code",[s._v("QueueBuilder")]),s._v("的"),t("code",[s._v("lazy()")]),s._v("函数配置Lazy模式，底层源码如下：")]),s._v(" "),t("p",[t("strong",[s._v("当然，我们也可以基于注解来声明队列并设置为Lazy模式：")])]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queuesToDeclare "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Queue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lazy.queue"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        durable "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        arguments "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Argument")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"x-queue-mode"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" value "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"lazy"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenLazyQueue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"接收到 lazy.queue的消息：{}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" msg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("对于已经存在的队列，也可以配置为lazy模式，但是要通过设置policy实现。\n可以基于命令行设置policy：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("rabbitmqctl set_policy Lazy "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^lazy-queue$"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('\'{"queue-mode":"lazy"}\'')]),s._v(" --apply-to queues  \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("命令解读：")]),s._v(" "),t("ul",[t("li",[t("strong",[t("code",[s._v("rabbitmqctl")]),s._v(" ：RabbitMQ的命令行工具")])]),s._v(" "),t("li",[t("code",[s._v("set_policy")]),s._v(" ：添加一个策略")]),s._v(" "),t("li",[t("code",[s._v("Lazy")]),s._v(" ：策略名称，可以自定义")]),s._v(" "),t("li",[t("code",[s._v('"^lazy-queue$"')]),s._v(" ：用正则表达式匹配队列的名字")]),s._v(" "),t("li",[t("code",[s._v('\'{"queue-mode":"lazy"}\'')]),s._v(" ：设置队列模式为lazy模式")]),s._v(" "),t("li",[t("code",[s._v("--apply-to queues")]),s._v("：策略的作用对象，是所有的队列")])]),s._v(" "),t("p",[s._v("当然，也可以在控制台配置policy，进入在控制台的"),t("code",[s._v("Admin")]),s._v("页面，点击"),t("code",[s._v("Policies")]),s._v("，即可添加配置：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102858812.png",alt:"image-20231018102751000"}})]),s._v(" "),t("h2",{attrs:{id:"消费者可靠性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#消费者可靠性"}},[s._v("#")]),s._v(" 消费者可靠性")]),s._v(" "),t("p",[s._v("当RabbitMQ向消费者投递消息以后，需要知道消费者的处理状态如何。因为消息投递给消费者并不代表就一定被正确消费了，可能出现的故障有很多，比如：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("消息投递的过程中出现了网络故障")])]),s._v(" "),t("li",[t("strong",[s._v("消费者接收到消息后突然宕机")])]),s._v(" "),t("li",[t("strong",[s._v("消费者接收到消息后，因处理不当导致异常")])]),s._v(" "),t("li",[s._v("...")])]),s._v(" "),t("p",[s._v("一旦发生上述情况，消息也会丢失。因此，RabbitMQ必须知道消费者的处理状态，一旦消息处理失败才能重新投递消息。")]),s._v(" "),t("h3",{attrs:{id:"消费者确认"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#消费者确认"}},[s._v("#")]),s._v(" 消费者确认")]),s._v(" "),t("p",[s._v("为了确认消费者是否成功处理消息，RabbitMQ提供了消费者确认机制（"),t("strong",[s._v("Consumer Acknowledgement")]),s._v("）。即：当消费者处理消息结束后**，应该向RabbitMQ发送一个回执，告知RabbitMQ自己消息处理状态。回执有三种可选值：**")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("ack：成功处理消息，RabbitMQ从队列中删除该消息")])]),s._v(" "),t("li",[t("strong",[s._v("nack：消息处理失败，RabbitMQ需要再次投递消息")])]),s._v(" "),t("li",[t("strong",[s._v("reject：消息处理失败并拒绝该消息，RabbitMQ从队列中删除该消息")])])]),s._v(" "),t("p",[t("strong",[s._v("一般reject方式用的较少，除非是消息格式有问题，那就是开发问题了。因此大多数情况下我们需要将消息处理的代码通过"),t("code",[s._v("try catch")]),s._v("机制捕获，消息处理成功时返回ack，处理失败时返回nack.")])]),s._v(" "),t("p",[t("strong",[s._v("由于消息回执的处理代码比较统一，因此SpringAMQP帮我们实现了消息确认。并允许我们通过配置文件设置ACK处理方式，有三种模式：")])]),s._v(" "),t("ul",[t("li",[t("code",[s._v("none")]),s._v("：不处理。即消息投递给消费者后立刻ack，消息会立刻从MQ删除。非常不安全，不建议使用")]),s._v(" "),t("li",[t("code",[s._v("manual")]),s._v("：手动模式。需要自己在业务代码中调用api，发送"),t("code",[s._v("ack")]),s._v("或"),t("code",[s._v("reject")]),s._v("，存在业务入侵，但更灵活")]),s._v(" "),t("li",[t("code",[s._v("auto")]),s._v("：自动模式。SpringAMQP利用AOP对我们的消息处理逻辑做了环绕增强，当业务正常执行时则自动返回"),t("code",[s._v("ack")]),s._v(".  当业务出现异常时，根据异常判断返回不同结果：\n"),t("ul",[t("li",[s._v("如果是"),t("strong",[s._v("业务异常")]),s._v("，会自动返回"),t("code",[s._v("nack")]),s._v("；")]),s._v(" "),t("li",[s._v("如果是"),t("strong",[s._v("消息处理或校验异常")]),s._v("，自动返回"),t("code",[s._v("reject")]),s._v(";")])])])]),s._v(" "),t("p",[s._v("通过下面的配置可以修改SpringAMQP的ACK处理方式：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("simple")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("acknowledge-mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" none "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不做处理")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("修改consumer服务的SpringRabbitListener类中的方法，模拟一个消息处理的异常：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queues "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenSimpleQueueMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"spring 消费者接收到消息：【"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessageConversionException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"故意的"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消息处理完成"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("测试可以发现：当消息处理发生异常时，消息依然被RabbitMQ删除了。")]),s._v(" "),t("p",[s._v("我们再次把确认机制修改为auto：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("simple")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("acknowledge-mode")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" auto "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 自动ack")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("在异常位置打断点，再次发送消息，程序卡在断点时，可以发现此时消息状态为"),t("code",[s._v("unacked")]),s._v("（未确定状态）：\n放行以后，由于抛出的是"),t("strong",[s._v("消息转换异常")]),s._v("，因此Spring会自动返回"),t("code",[s._v("reject")]),s._v("，所以消息依然会被删除：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102916860.png",alt:"image-20231018102832421"}})]),s._v(" "),t("p",[s._v("我们将异常改为RuntimeException类型：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("queues "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"simple.queue"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenSimpleQueueMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"spring 消费者接收到消息：【"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" msg "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"】"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RuntimeException")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"故意的"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"消息处理完成"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("在异常位置打断点，然后再次发送消息测试，程序卡在断点时，可以发现此时消息状态为"),t("code",[s._v("unacked")]),s._v("（未确定状态）：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102751000.png",alt:"image-20231018102858812"}}),s._v("放行以后，由于抛出的是业务异常，所以Spring返回"),t("code",[s._v("ack")]),s._v("，最终消息恢复至"),t("code",[s._v("Ready")]),s._v("状态，并且没有被RabbitMQ删除：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102936476.png",alt:"image-20231018102916860"}}),s._v("\n当我们把配置改为"),t("code",[s._v("auto")]),s._v("时，消息处理失败后，会回到RabbitMQ，并重新投递到消费者。")]),s._v(" "),t("h3",{attrs:{id:"失败重试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#失败重试"}},[s._v("#")]),s._v(" 失败重试")]),s._v(" "),t("p",[s._v("当消费者出现异常后，消息会不断requeue（重入队）到队列，再重新发送给消费者。如果消费者再次执行依然出错，消息会再次requeue到队列，再次投递，直到消息处理成功为止。\n极端情况就是消费者一直无法执行成功，那么消息requeue就会无限循环，导致mq的消息处理飙升，带来不必要的压力。")]),s._v(" "),t("p",[t("strong",[s._v("Spring又提供了消费者失败重试机制：在消费者出现异常时利用本地重试，而不是无限制的requeue到mq队列。")])]),s._v(" "),t("p",[t("strong",[s._v("修改consumer服务的application.yml文件，添加内容：")])]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rabbitmq")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("listener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("simple")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("retry")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enabled")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启消费者失败重试")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initial-interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1000ms "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初识的失败等待时长为1秒")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("multiplier")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 失败的等待时长倍数，下次等待时长 = multiplier * last-interval")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max-attempts")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 最大重试次数")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stateless")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# true无状态；false有状态。如果业务中包含事务，这里改为false")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("重启consumer服务，重复之前的测试。可以发现：")]),s._v(" "),t("ul",[t("li",[s._v("消费者在失败后消息没有重新回到MQ无限重新投递，而是在本地重试了3次")]),s._v(" "),t("li",[s._v("本地重试3次以后，抛出了"),t("code",[s._v("AmqpRejectAndDontRequeueException")]),s._v("异常。查看RabbitMQ控制台，发现消息被删除了，说明最后SpringAMQP返回的是"),t("code",[s._v("reject")])])]),s._v(" "),t("p",[s._v("结论：")]),s._v(" "),t("ul",[t("li",[s._v("开启本地重试时，消息处理过程中抛出异常，不会requeue到队列，而是在消费者本地重试")]),s._v(" "),t("li",[s._v("重试达到最大次数后，Spring会返回reject，消息会被丢弃")])]),s._v(" "),t("h3",{attrs:{id:"失败处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#失败处理"}},[s._v("#")]),s._v(" 失败处理")]),s._v(" "),t("p",[s._v("还是继续失败，这个时候就要编写失败后的处理逻辑了")]),s._v(" "),t("p",[t("strong",[s._v("在之前的测试中，本地测试达到最大重试次数后，消息会被丢弃。"),t("strong",[s._v("这在某些对于消息可靠性要求较高的业务场景下，显然不太合适了。\n因此")]),s._v("Spring允许我们自定义重试次数耗尽后的消息处理策略，这个策略是由"),t("code",[s._v("MessageRecovery")]),s._v("接口来定义的，它有3个不同实现：")])]),s._v(" "),t("ul",[t("li",[t("strong",[t("code",[s._v("RejectAndDontRequeueRecoverer")]),s._v("：重试耗尽后，直接"),t("code",[s._v("reject")]),s._v("，丢弃消息。默认就是这种方式")])]),s._v(" "),t("li",[t("strong",[t("code",[s._v("ImmediateRequeueMessageRecoverer")]),s._v("：重试耗尽后，返回"),t("code",[s._v("nack")]),s._v("，消息重新入队")])]),s._v(" "),t("li",[t("strong",[t("code",[s._v("RepublishMessageRecoverer")]),s._v("：重试耗尽后，将失败消息投递到指定的交换机")])])]),s._v(" "),t("p",[t("strong",[s._v("比较优雅的一种处理方案是"),t("code",[s._v("RepublishMessageRecoverer")]),s._v("，失败后将消息投递到一个指定的，专门存放异常消息的队列，后续由人工集中处理。")])]),s._v(" "),t("p",[s._v("// TODO")]),s._v(" "),t("p",[s._v("// 留个印象先")]),s._v(" "),t("h3",{attrs:{id:"兜底方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#兜底方案"}},[s._v("#")]),s._v(" 兜底方案")]),s._v(" "),t("p",[s._v("// TODO")]),s._v(" "),t("h2",{attrs:{id:"延迟消息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#延迟消息"}},[s._v("#")]),s._v(" 延迟消息")]),s._v(" "),t("p",[s._v("在电商的支付业务中，对于一些库存有限的商品，为了更好的用户体验，通常都会在用户下单时立刻扣减商品库存。例如电影院购票、高铁购票，下单后就会锁定座位资源，其他人无法重复购买。")]),s._v(" "),t("p",[s._v("但是这样就存在一个问题，假如用户下单后一直不付款，就会一直占有库存资源，导致其他客户无法正常交易，最终导致商户利益受损！")]),s._v(" "),t("p",[s._v("因此，电商中通常的做法就是："),t("strong",[s._v("对于超过一定时间未支付的订单，应该立刻取消订单并释放占用的库存")]),s._v("。")]),s._v(" "),t("p",[s._v("例如，订单支付超时时间为30分钟，则我们应该在用户下单后的第30分钟检查订单支付状态，如果发现未支付，应该立刻取消订单，释放库存。")]),s._v(" "),t("p",[s._v("但问题来了：如何才能准确的实现在下单后第30分钟去检查支付状态呢？")]),s._v(" "),t("p",[s._v("像这种在一段时间以后才执行的任务，我们称之为"),t("strong",[s._v("延迟任务")]),s._v("，而要实现延迟任务，最简单的方案就是利用MQ的延迟消息了。")]),s._v(" "),t("p",[s._v("在RabbitMQ中实现延迟消息也有两种方案：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("死信交换机+TTL")])]),s._v(" "),t("li",[t("strong",[s._v("延迟消息插件")])])]),s._v(" "),t("h3",{attrs:{id:"死信交换机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#死信交换机"}},[s._v("#")]),s._v(" 死信交换机")]),s._v(" "),t("p",[t("strong",[s._v("当一个队列中的消息满足下列情况之一时，可以成为死信（dead letter）：")])]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("消费者使用"),t("code",[s._v("basic.reject")]),s._v("或 "),t("code",[s._v("basic.nack")]),s._v("声明消费失败，并且消息的"),t("code",[s._v("requeue")]),s._v("参数设置为false   消费者不要消息，并且不能再入队了")])]),s._v(" "),t("li",[t("strong",[s._v("消息是一个过期消息，超时无人消费")])]),s._v(" "),t("li",[t("strong",[s._v("要投递的队列消息满了，无法投递")])])]),s._v(" "),t("p",[s._v("如果一个队列中的消息已经成为死信，并且这个队列"),t("strong",[s._v("通过"),t("code",[s._v("dead-letter-exchange")]),s._v("属性指定了一个交换机，那么队列中的死信就会投递到这个交换机中")]),s._v("，而这个交换机就称为"),t("strong",[s._v("死信交换机")]),s._v("（Dead Letter Exchange）。而此时加入有队列与死信交换机绑定，则最终死信就会被投递到这个队列中。")]),s._v(" "),t("p",[s._v("死信交换机有什么作用呢？")]),s._v(" "),t("ol",[t("li",[t("strong",[s._v("收集那些因处理失败而被拒绝的消息")])]),s._v(" "),t("li",[t("strong",[s._v("收集那些因队列满了而被拒绝的消息")])]),s._v(" "),t("li",[t("strong",[s._v("收集因TTL（有效期）到期的消息")])])]),s._v(" "),t("h3",{attrs:{id:"延迟消息-2"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#延迟消息-2"}},[s._v("#")]),s._v(" 延迟消息")]),s._v(" "),t("p",[s._v("如图，有一组绑定的交换机（"),t("code",[s._v("ttl.fanout")]),s._v("）和队列（"),t("code",[s._v("ttl.queue")]),s._v("）。"),t("strong",[s._v("但是"),t("code",[s._v("ttl.queue")]),s._v("没有消费者监听，而是设定了死信交换机"),t("code",[s._v("hmall.direct")]),s._v("，而队列"),t("code",[s._v("direct.queue1")]),s._v("则与死信交换机绑定，RoutingKey是blue：")]),s._v(" "),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102955037.png",alt:"image-20231018102936476"}})]),s._v(" "),t("p",[s._v("假如我们现在发送一条消息到"),t("code",[s._v("ttl.fanout")]),s._v("，RoutingKey为blue，并设置消息的"),t("strong",[s._v("有效期")]),s._v("为5000毫秒：\n"),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018103017054.png",alt:"image-20231018102955037"}})]),s._v(" "),t("p",[t("strong",[s._v("注意")]),s._v("：尽管这里的"),t("code",[s._v("ttl.fanout")]),s._v("不需要RoutingKey，但是当消息变为死信并投递到死信交换机时，会沿用之前的RoutingKey，这样"),t("code",[s._v("hmall.direct")]),s._v("才能正确路由消息。")]),s._v(" "),t("p",[s._v("消息肯定会被投递到"),t("code",[s._v("ttl.queue")]),s._v("之后，由于没有消费者，因此消息无人消费。"),t("strong",[s._v("5秒之后，消息的有效期到期，成为死信：")]),s._v(" "),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018103036781.png",alt:"image-20231018103017054"}})]),s._v(" "),t("p",[s._v("死信被再次投递到死信交换机"),t("code",[s._v("hmall.direct")]),s._v("，"),t("strong",[s._v("并沿用之前的RoutingKey，也就是"),t("code",[s._v("blue")]),s._v("：")]),s._v(" "),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018103053390.png",alt:"image-20231018103036781"}})]),s._v(" "),t("p",[s._v("由于"),t("code",[s._v("direct.queue1")]),s._v("与"),t("code",[s._v("hmall.direct")]),s._v("绑定的key是blue，因此最终消息被成功路由到"),t("code",[s._v("direct.queue1")]),s._v("，如果此时有消费者与"),t("code",[s._v("direct.queue1")]),s._v("绑定， "),t("strong",[s._v("也就能成功消费消息了。但此时已经是5秒钟以后了：")]),s._v(" "),t("img",{attrs:{src:"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20231018102543966.png",alt:"image-20231018103053390"}}),s._v("\n也就是说，publisher发送了一条消息，但最终consumer在5秒后才收到消息。我们成功实现了"),t("strong",[s._v("延迟消息")]),s._v("。")]),s._v(" "),t("p",[s._v("RabbitMQ的消息过期是基于追溯方式来实现的，**也就是说当一个消息的TTL到期以后不一定会被移除或投递到死信交换机，而是在消息恰好处于队首时才会被处理。****当队列中消息堆积很多的时候，过期消息可能不会被按时处理，因此设置的TTL时间不一定准确。")]),s._v(" "),t("h3",{attrs:{id:"声明延迟交换机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#声明延迟交换机"}},[s._v("#")]),s._v(" 声明延迟交换机")]),s._v(" "),t("p",[s._v("基于注解方式：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@RabbitListener")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bindings "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@QueueBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        value "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Queue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delay.queue"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" durable "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        exchange "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Exchange")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delay.direct"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" delayed "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        key "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delay"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("listenDelayMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" msg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"接收到delay.queue的延迟消息：{}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" msg"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("基于"),t("code",[s._v("@Bean")]),s._v("的方式：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("itheima"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("consumer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("lombok"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("extern"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("slf4j"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Slf4j")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("amqp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("core"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Bean")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("springframework"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("context"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Configuration")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Slf4j")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Configuration")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DelayExchangeConfig")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("DirectExchange")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("delayExchange")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ExchangeBuilder")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("directExchange")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delay.direct"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 指定交换机类型和名称")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("delayed")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 设置delay的属性为true")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("durable")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 持久化")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("build")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("delayedQueue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Queue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delay.queue"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Bean")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Binding")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("delayQueueBinding")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("BindingBuilder")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("delayedQueue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("delayExchange")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delay"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("h3",{attrs:{id:"发送延迟消息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#发送延迟消息"}},[s._v("#")]),s._v(" 发送延迟消息")]),s._v(" "),t("p",[s._v("发送消息时，必须通过x-delay属性设定延迟时间：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Test")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("testPublisherDelayMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1.创建消息")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" message "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello, delayed message"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2.发送消息，利用消息后置处理器添加消息头")]),s._v("\n    rabbitTemplate"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("convertAndSend")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delay.direct"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"delay"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MessagePostProcessor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Message")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("postProcessMessage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Message")]),s._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("AmqpException")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 添加延迟消息属性")]),s._v("\n            message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMessageProperties")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("setDelay")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" message"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);