(window.webpackJsonp=window.webpackJsonp||[]).push([[193],{522:function(t,s,a){"use strict";a.r(s);var n=a(4),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"_5-4-怎么避免死锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-怎么避免死锁"}},[t._v("#")]),t._v(" 5.4 怎么避免死锁？")]),t._v(" "),s("p",[t._v("面试过程中，死锁也是高频的考点，因为如果线上环境真多发生了死锁，那真的出大事了。")]),t._v(" "),s("p",[t._v("这次，我们就来系统地聊聊死锁的问题。")]),t._v(" "),s("ul",[s("li",[t._v("死锁的概念；")]),t._v(" "),s("li",[t._v("模拟死锁问题的产生；")]),t._v(" "),s("li",[t._v("利用工具排查死锁问题；")]),t._v(" "),s("li",[t._v("避免死锁问题的发生；")])]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"死锁的概念"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#死锁的概念"}},[t._v("#")]),t._v(" 死锁的概念")]),t._v(" "),s("p",[t._v("在多线程编程中，我们为了防止多线程竞争共享资源而导致数据错乱，都会在操作共享资源之前加上互斥锁，只有成功获得到锁的线程，才能操作共享资源，获取不到锁的线程就只能等待，直到锁被释放。")]),t._v(" "),s("p",[t._v("那么，当两个线程为了保护两个不同的共享资源而使用了两个互斥锁，那么这两个互斥锁应用不当的时候，可能会造成"),s("strong",[t._v("两个线程都在等待对方释放锁")]),t._v("，在没有外力的作用下，这些线程会一直相互等待，就没办法继续运行，这种情况就是发生了"),s("strong",[t._v("死锁")]),t._v("。")]),t._v(" "),s("p",[t._v("举个例子，小林拿了小美房间的钥匙，而小林在自己的房间里，小美拿了小林房间的钥匙，而小美也在自己的房间里。如果小林要从自己的房间里出去，必须拿到小美手中的钥匙，但是小美要出去，又必须拿到小林手中的钥匙，这就形成了死锁。")]),t._v(" "),s("p",[t._v("死锁只有"),s("strong",[t._v("同时满足")]),t._v("以下四个条件才会发生：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("互斥条件；")])]),t._v(" "),s("li",[s("strong",[t._v("持有并等待条件；")])]),t._v(" "),s("li",[s("strong",[t._v("不可剥夺条件；")])]),t._v(" "),s("li",[s("strong",[t._v("环路等待条件；")])])]),t._v(" "),s("h3",{attrs:{id:"互斥条件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#互斥条件"}},[t._v("#")]),t._v(" 互斥条件")]),t._v(" "),s("p",[t._v("互斥条件是指"),s("strong",[t._v("多个线程不能同时使用同一个资源")]),t._v("。")]),t._v(" "),s("p",[t._v("比如下图，如果线程 A 已经持有的资源，不能再同时被线程 B 持有，如果线程 B 请求获取线程 A 已经占用的资源，那线程 B 只能等待，直到线程 A 释放了资源。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%AD%BB%E9%94%81/%E4%BA%92%E6%96%A5%E6%9D%A1%E4%BB%B6.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"持有并等待条件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#持有并等待条件"}},[t._v("#")]),t._v(" 持有并等待条件")]),t._v(" "),s("p",[t._v("持有并等待条件是指，当线程 A 已经持有了资源 1，又想申请资源 2，而资源 2 已经被线程 C 持有了，所以线程  A 就会处于等待状态，但是"),s("strong",[t._v("线程  A 在等待资源 2 的同时并不会释放自己已经持有的资源 1")]),t._v("。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%AD%BB%E9%94%81/%E6%8C%81%E6%9C%89%E5%B9%B6%E7%AD%89%E5%BE%85%E6%9D%A1%E4%BB%B6.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"不可剥夺条件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#不可剥夺条件"}},[t._v("#")]),t._v(" 不可剥夺条件")]),t._v(" "),s("p",[t._v("不可剥夺条件是指，当线程已经持有了资源，"),s("strong",[t._v("在自己使用完之前不能被其他线程获取")]),t._v("，线程 B 如果也想使用此资源，则只能在线程 A 使用完并释放后才能获取。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%AD%BB%E9%94%81/%E4%B8%8D%E5%8F%AF%E5%89%A5%E5%A4%BA%E6%9D%A1%E4%BB%B6.png",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"环路等待条件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#环路等待条件"}},[t._v("#")]),t._v(" 环路等待条件")]),t._v(" "),s("p",[t._v("环路等待条件指的是，在死锁发生的时候，"),s("strong",[t._v("两个线程获取资源的顺序构成了环形链")]),t._v("。")]),t._v(" "),s("p",[t._v("比如，线程 A 已经持有资源 2，而想请求资源 1，线程 B 已经获取了资源 1，而想请求资源 2，这就形成资源请求等待的环形图。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%AD%BB%E9%94%81/%E7%8E%AF%E8%B7%AF%E7%AD%89%E5%BE%85%E6%9D%A1%E4%BB%B6.png",alt:""}})]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"模拟死锁问题的产生"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#模拟死锁问题的产生"}},[t._v("#")]),t._v(" 模拟死锁问题的产生")]),t._v(" "),s("p",[t._v("Talk is cheap. Show me the code.")]),t._v(" "),s("p",[t._v("下面，我们用代码来模拟死锁问题的产生。")]),t._v(" "),s("p",[t._v("首先，我们先创建 2 个线程，分别为线程 A 和 线程 B，然后有两个互斥锁，分别是 mutex_A 和 mutex_B，代码如下：")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pthread_mutex_t")]),t._v(" mutex_A "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" PTHREAD_MUTEX_INITIALIZER"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pthread_mutex_t")]),t._v(" mutex_B "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" PTHREAD_MUTEX_INITIALIZER"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("pthread_t")]),t._v(" tidA"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tidB"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//创建两个线程")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tidA"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" threadA_proc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tidB"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" threadB_proc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_join")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tidA"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_join")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tidB"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("NULL")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"exit\\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br")])]),s("p",[t._v("接下来，我们看下线程 A 函数做了什么。")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//线程函数 A")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("threadA_proc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread A waiting get ResourceA \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_lock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread A got ResourceA \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread A waiting get ResourceB \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_lock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_B"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread A got ResourceB \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_unlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_B"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_unlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br")])]),s("p",[t._v("可以看到，线程 A 函数的过程：")]),t._v(" "),s("ul",[s("li",[t._v("先获取互斥锁 A，然后睡眠 1 秒；")]),t._v(" "),s("li",[t._v("再获取互斥锁 B，然后释放互斥锁 B；")]),t._v(" "),s("li",[t._v("最后释放互斥锁 A；")])]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//线程函数 B")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("threadB_proc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread B waiting get ResourceB \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_lock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_B"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread B got ResourceB \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread B waiting  get ResourceA \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_lock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread B got ResourceA \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_unlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_unlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_B"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br")])]),s("p",[t._v("可以看到，线程 B 函数的过程：")]),t._v(" "),s("ul",[s("li",[t._v("先获取互斥锁 B，然后睡眠 1 秒；")]),t._v(" "),s("li",[t._v("再获取互斥锁 A，然后释放互斥锁 A；")]),t._v(" "),s("li",[t._v("最后释放互斥锁 B；")])]),t._v(" "),s("p",[t._v("然后，我们运行这个程序，运行结果如下：")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("thread B waiting get ResourceB \nthread B got ResourceB \nthread A waiting get ResourceA \nthread A got ResourceA \nthread B waiting get ResourceA \nthread A waiting get ResourceB \n// 阻塞中。。。\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("可以看到线程 B 在等待互斥锁 A 的释放，线程 A 在等待互斥锁 B 的释放，双方都在等待对方资源的释放，很明显，产生了死锁问题。")]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"利用工具排查死锁问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#利用工具排查死锁问题"}},[t._v("#")]),t._v(" 利用工具排查死锁问题")]),t._v(" "),s("p",[s("strong",[t._v("如果你想排查你的 Java 程序是否死锁，则可以使用 "),s("code",[t._v("jstack")]),t._v(" 工具，它是 jdk 自带的线程堆栈分析工具。")])]),t._v(" "),s("p",[t._v("由于小林的死锁代码例子是 C 写的，在 Linux 下，我们可以使用 "),s("code",[t._v("pstack")]),t._v(" + "),s("code",[t._v("gdb")]),t._v(" 工具来定位死锁问题。")]),t._v(" "),s("p",[t._v("pstack 命令可以显示每个线程的栈跟踪信息（函数调用过程），它的使用方式也很简单，只需要 "),s("code",[t._v("pstack <pid>")]),t._v(" 就可以了。")]),t._v(" "),s("p",[t._v("那么，在定位死锁问题时，我们可以多次执行 pstack 命令查看线程的函数调用过程，多次对比结果，确认哪几个线程一直没有变化，且是因为在等待锁，那么大概率是由于死锁问题导致的。")]),t._v(" "),s("p",[t._v("我用 pstack 输出了我前面模拟死锁问题的进程的所有线程的情况，我多次执行命令后，其结果都一样，如下：")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("$ pstack "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87746")]),t._v("\nThread "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Thread 0x7f60a610a700 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LWP "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87747")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),t._v(":\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0  0x0000003720e0da1d in __lll_lock_wait () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#1  0x0000003720e093ca in _L_lock_829 () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#2  0x0000003720e09298 in pthread_mutex_lock () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#3  0x0000000000400725 in threadA_proc ()")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#4  0x0000003720e07893 in start_thread () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#5  0x00000037206f4bfd in clone () from /lib64/libc.so.6")]),t._v("\nThread "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Thread 0x7f60a5709700 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LWP "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87748")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),t._v(":\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0  0x0000003720e0da1d in __lll_lock_wait () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#1  0x0000003720e093ca in _L_lock_829 () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#2  0x0000003720e09298 in pthread_mutex_lock () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#3  0x0000000000400792 in threadB_proc ()")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#4  0x0000003720e07893 in start_thread () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#5  0x00000037206f4bfd in clone () from /lib64/libc.so.6")]),t._v("\nThread "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Thread 0x7f60a610c700 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LWP "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87746")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),t._v(":\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0  0x0000003720e080e5 in pthread_join () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#1  0x0000000000400806 in main ()")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("\n\n$ pstack "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87746")]),t._v("\nThread "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Thread 0x7f60a610a700 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LWP "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87747")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),t._v(":\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0  0x0000003720e0da1d in __lll_lock_wait () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#1  0x0000003720e093ca in _L_lock_829 () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#2  0x0000003720e09298 in pthread_mutex_lock () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#3  0x0000000000400725 in threadA_proc ()")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#4  0x0000003720e07893 in start_thread () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#5  0x00000037206f4bfd in clone () from /lib64/libc.so.6")]),t._v("\nThread "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Thread 0x7f60a5709700 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LWP "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87748")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),t._v(":\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0  0x0000003720e0da1d in __lll_lock_wait () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#1  0x0000003720e093ca in _L_lock_829 () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#2  0x0000003720e09298 in pthread_mutex_lock () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#3  0x0000000000400792 in threadB_proc ()")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#4  0x0000003720e07893 in start_thread () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#5  0x00000037206f4bfd in clone () from /lib64/libc.so.6")]),t._v("\nThread "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Thread 0x7f60a610c700 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LWP "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87746")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),t._v(":\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0  0x0000003720e080e5 in pthread_join () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#1  0x0000000000400806 in main ()")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br"),s("span",{staticClass:"line-number"},[t._v("39")]),s("br")])]),s("p",[t._v("可以看到，Thread 2 和 Thread 3 一直阻塞获取锁（"),s("em",[t._v("pthread_mutex_lock")]),t._v("）的过程，而且 pstack 多次输出信息都没有变化，那么可能大概率发生了死锁。")]),t._v(" "),s("p",[t._v("但是，还不能够确认这两个线程是在互相等待对方的锁的释放，因为我们看不到它们是等在哪个锁对象，于是我们可以使用 gdb 工具进一步确认。")]),t._v(" "),s("p",[t._v("整个 gdb 调试过程，如下：")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("// gdb 命令\n$ gdb "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87746")]),t._v("\n\n// 打印所有的线程信息\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gdb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" info thread\n  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" Thread 0x7f60a610a700 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LWP "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87747")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  0x0000003720e0da1d "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" __lll_lock_wait "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" from /lib64/libpthread.so.0\n  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" Thread 0x7f60a5709700 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LWP "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87748")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  0x0000003720e0da1d "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" __lll_lock_wait "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" from /lib64/libpthread.so.0\n* "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" Thread 0x7f60a610c700 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LWP "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87746")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("  0x0000003720e080e5 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" pthread_join "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" from /lib64/libpthread.so.0\n//最左边的 * 表示 gdb 锁定的线程，切换到第二个线程去查看\n\n// 切换到第2个线程\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gdb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" thread "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("Switching to thread "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Thread 0x7f60a5709700 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("LWP "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87748")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0  0x0000003720e0da1d in __lll_lock_wait () from /lib64/libpthread.so.0 ")]),t._v("\n\n// bt 可以打印函数堆栈，却无法看到函数参数，跟 pstack 命令一样 \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gdb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" bt\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0  0x0000003720e0da1d in __lll_lock_wait () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#1  0x0000003720e093ca in _L_lock_829 () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#2  0x0000003720e09298 in pthread_mutex_lock () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#3  0x0000000000400792 in threadB_proc (data=0x0) at dead_lock.c:25")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#4  0x0000003720e07893 in start_thread () from /lib64/libpthread.so.0")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#5  0x00000037206f4bfd in clone () from /lib64/libc.so.6")]),t._v("\n\n// 打印第三帧信息，每次函数调用都会有压栈的过程，而 frame 则记录栈中的帧信息\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gdb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" frame "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#3  0x0000000000400792 in threadB_proc (data=0x0) at dead_lock.c:25")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("27")]),t._v("    printf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread B waiting get ResourceA '),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("28")]),t._v("    pthread_mutex_lock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n// 打印mutex_A的值 ,  __owner表示gdb中标示线程的值，即LWP\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gdb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" p mutex_A\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("__data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("__lock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(", __count "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", __owner "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87747")]),t._v(", __nusers "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", __kind "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", __spins "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", __list "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("__prev "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" 0x0, __next "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" 0x0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(", \n  __size "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\002"}},[t._v("\\002")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\303"}},[t._v("\\303")]),t._v("V"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\001"}},[t._v("\\001")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\001"}},[t._v("\\001")]),t._v('"')]),t._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\000'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("repeats "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v(" times"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(", __align "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n// 打印mutex_B的值 ,  __owner表示gdb中标示线程的值，即LWP\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("gdb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" p mutex_B\n"),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$2")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("__data "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("__lock "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(", __count "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", __owner "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("87748")]),t._v(", __nusers "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(", __kind "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", __spins "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(", __list "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("__prev "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" 0x0, __next "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" 0x0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(", \n  __size "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\002"}},[t._v("\\002")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\304"}},[t._v("\\304")]),t._v("V"),s("span",{pre:!0,attrs:{class:"token entity",title:"\\001"}},[t._v("\\001")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\000"}},[t._v("\\000")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\001"}},[t._v("\\001")]),t._v('"')]),t._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\000'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("repeats "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("26")]),t._v(" times"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(", __align "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("  \n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br"),s("span",{staticClass:"line-number"},[t._v("25")]),s("br"),s("span",{staticClass:"line-number"},[t._v("26")]),s("br"),s("span",{staticClass:"line-number"},[t._v("27")]),s("br"),s("span",{staticClass:"line-number"},[t._v("28")]),s("br"),s("span",{staticClass:"line-number"},[t._v("29")]),s("br"),s("span",{staticClass:"line-number"},[t._v("30")]),s("br"),s("span",{staticClass:"line-number"},[t._v("31")]),s("br"),s("span",{staticClass:"line-number"},[t._v("32")]),s("br"),s("span",{staticClass:"line-number"},[t._v("33")]),s("br"),s("span",{staticClass:"line-number"},[t._v("34")]),s("br"),s("span",{staticClass:"line-number"},[t._v("35")]),s("br"),s("span",{staticClass:"line-number"},[t._v("36")]),s("br"),s("span",{staticClass:"line-number"},[t._v("37")]),s("br"),s("span",{staticClass:"line-number"},[t._v("38")]),s("br")])]),s("p",[t._v("我来解释下，上面的调试过程：")]),t._v(" "),s("ol",[s("li",[t._v("通过 "),s("code",[t._v("info thread")]),t._v(" 打印了所有的线程信息，可以看到有 3 个线程，一个是主线程（LWP 87746），另外两个都是我们自己创建的线程（LWP 87747 和 87748）；")]),t._v(" "),s("li",[t._v("通过 "),s("code",[t._v("thread 2")]),t._v("，将切换到第 2 个线程（LWP 87748）；")]),t._v(" "),s("li",[t._v("通过 "),s("code",[t._v("bt")]),t._v("，打印线程的调用栈信息，可以看到有 threadB_proc 函数，说明这个是线程 B 函数，也就说 LWP 87748 是线程 B;")]),t._v(" "),s("li",[t._v("通过 "),s("code",[t._v("frame 3")]),t._v("，打印调用栈中的第三个帧的信息，可以看到线程 B 函数，在获取互斥锁 A 的时候阻塞了；")]),t._v(" "),s("li",[t._v("通过 "),s("code",[t._v("p mutex_A")]),t._v("，打印互斥锁 A 对象信息，可以看到它被 LWP 为 87747（线程 A）的线程持有着；")]),t._v(" "),s("li",[t._v("通过 "),s("code",[t._v("p mutex_B")]),t._v("，打印互斥锁 B 对象信息，可以看到他被 LWP 为 87748（线程 B）的线程持有着；")])]),t._v(" "),s("p",[t._v("因为线程 B 在等待线程 A 所持有的 mutex_A, 而同时线程 A 又在等待线程 B 所拥有的 mutex_B, 所以可以断定该程序发生了死锁。")]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"避免死锁问题的发生"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#避免死锁问题的发生"}},[t._v("#")]),t._v(" 避免死锁问题的发生")]),t._v(" "),s("p",[t._v("前面我们提到，产生死锁的四个必要条件是：互斥条件、持有并等待条件、不可剥夺条件、环路等待条件。")]),t._v(" "),s("p",[t._v("那么避免死锁问题就只需要破环其中一个条件就可以，最常见的并且可行的就是"),s("strong",[t._v("使用资源有序分配法，来破环环路等待条件")]),t._v("。")]),t._v(" "),s("p",[s("strong",[t._v("那什么是资源有序分配法呢？")])]),t._v(" "),s("p",[t._v("线程 A 和 线程 B 获取资源的顺序要一样，当线程 A 是先尝试获取资源 A，然后尝试获取资源  B 的时候，线程 B 同样也是先尝试获取资源 A，然后尝试获取资源 B。也就是说，线程 A 和 线程 B 总是以相同的顺序申请自己想要的资源。")]),t._v(" "),s("p",[t._v("我们使用资源有序分配法的方式来修改前面发生死锁的代码，我们可以不改动线程 A 的代码。")]),t._v(" "),s("p",[t._v("我们先要清楚线程 A 获取资源的顺序，它是先获取互斥锁 A，然后获取互斥锁 B。")]),t._v(" "),s("p",[t._v("所以我们只需将线程 B 改成以相同顺序的获取资源，就可以打破死锁了。")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%AD%BB%E9%94%81/%E8%B5%84%E6%BA%90%E6%9C%89%E5%BA%8F%E5%88%86%E9%85%8D.png",alt:""}})]),t._v(" "),s("p",[t._v("线程 B 函数改进后的代码如下：")]),t._v(" "),s("div",{staticClass:"language-c line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//线程 B 函数，同线程 A 一样，先获取互斥锁 A，然后获取互斥锁 B")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("threadB_proc")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread B waiting get ResourceA \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_lock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread B got ResourceA \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread B waiting  get ResourceB \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_lock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_B"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"thread B got ResourceB \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_unlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_B"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pthread_mutex_unlock")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("mutex_A"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br")])]),s("p",[t._v("执行结果如下，可以看，没有发生死锁。")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("thread B waiting get ResourceA \nthread B got ResourceA \nthread A waiting get ResourceA \nthread B waiting  get ResourceB \nthread B got ResourceB \nthread A got ResourceA \nthread A waiting get ResourceB \nthread A got ResourceB\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("hr"),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("p",[t._v("简单来说，死锁问题的产生是由两个或者以上线程并行执行的时候，争夺资源而互相等待造成的。")]),t._v(" "),s("p",[t._v("死锁只有同时满足互斥、持有并等待、不可剥夺、环路等待这四个条件的时候才会发生。")]),t._v(" "),s("p",[t._v("所以要避免死锁问题，就是要破坏其中一个条件即可，最常用的方法就是使用资源有序分配法来破坏环路等待条件。")])])}),[],!1,null,null,null);s.default=e.exports}}]);