{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{382:function(s,t,a){\"use strict\";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":s.$parent.slotKey}},[t(\"h1\",{attrs:{id:\"微服务保护\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#微服务保护\"}},[s._v(\"#\")]),s._v(\" 微服务保护\")]),s._v(\" \"),t(\"h1\",{attrs:{id:\"_1-初识sentinel\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-初识sentinel\"}},[s._v(\"#\")]),s._v(\" 1.初识Sentinel\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_1-1-雪崩问题及解决方案\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-1-雪崩问题及解决方案\"}},[s._v(\"#\")]),s._v(\" 1.1.雪崩问题及解决方案\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_1-1-1-雪崩问题\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-1-1-雪崩问题\"}},[s._v(\"#\")]),s._v(\" 1.1.1.雪崩问题\")]),s._v(\" \"),t(\"p\",[s._v(\"微服务中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。\")]),s._v(\" \"),t(\"p\",[s._v(\"如图，如果服务提供者I发生了故障，当前的应用的部分业务因为依赖于服务I，因此也会被阻塞。此时，其它不依赖于服务I的业务\"),t(\"strong\",[s._v(\"似乎不受影响。\")])]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/1533829198240.png\",alt:\"1533829198240\"}})]),s._v(\" \"),t(\"p\",[s._v(\"但是，\"),t(\"strong\",[s._v(\"依赖服务I的业务请求被阻塞，用户不会得到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞\")]),s._v(\"：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715172710340.png\",alt:\"1533829307389\"}})]),s._v(\" \"),t(\"p\",[s._v(\"服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，那么当前服务也就不可用了。\")]),s._v(\" \"),t(\"p\",[s._v(\"那么，依赖于当前服务的其它服务随着时间的推移，最终也都会变的不可用，\"),t(\"strong\",[s._v(\"形成级联失败，雪崩就发生了\")]),s._v(\"：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715172820438.png\",alt:\"image-20210715172710340\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_1-1-2-超时处理\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-1-2-超时处理\"}},[s._v(\"#\")]),s._v(\" 1.1.2.超时处理\")]),s._v(\" \"),t(\"p\",[s._v(\"解决雪崩问题的常见方式有四种：\")]),s._v(\" \"),t(\"p\",[s._v(\"•超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715173215243.png\",alt:\"image-20210715172820438\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_1-1-3-仓壁模式-线程隔离\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-1-3-仓壁模式-线程隔离\"}},[s._v(\"#\")]),s._v(\" 1.1.3.仓壁模式   线程隔离\")]),s._v(\" \"),t(\"p\",[s._v(\"方案2：仓壁模式\")]),s._v(\" \"),t(\"p\",[s._v(\"仓壁模式来源于船舱的设计：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715172946352.png\",alt:\"image-20210715172946352\"}})]),s._v(\" \"),t(\"p\",[s._v(\"船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。\")]),s._v(\" \"),t(\"p\",[s._v(\"于此类似，我们\"),t(\"strong\",[s._v(\"可以限定每个业务能使用的线程数，避免耗尽整个tomcat的资源，因此也叫线程隔离。\")])]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715173428073.png\",alt:\"image-20210715173215243\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_1-1-4-断路器\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-1-4-断路器\"}},[s._v(\"#\")]),s._v(\" 1.1.4.断路器\")]),s._v(\" \"),t(\"p\",[s._v(\"断路器模式：由\"),t(\"strong\",[s._v(\"断路器\")]),s._v(\"统计业务执行的异常比例，如果超出阈值则会\"),t(\"strong\",[s._v(\"熔断\")]),s._v(\"该业务，拦截访问该业务的一切请求。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"断路器会统计访问某个服务的请求数量，异常比例\")]),s._v(\"：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715173327075.png\",alt:\"image-20210715173327075\"}})]),s._v(\" \"),t(\"p\",[s._v(\"当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715190827846.png\",alt:\"image-20210715173428073\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_1-1-5-限流\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-1-5-限流\"}},[s._v(\"#\")]),s._v(\" 1.1.5.限流\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"流量控制\")]),s._v(\"：限制业务访问的QPS，避免服务因流量的突增而故障。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715173555158.png\",alt:\"image-20210715173555158\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_1-1-6-总结\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-1-6-总结\"}},[s._v(\"#\")]),s._v(\" 1.1.6.总结\")]),s._v(\" \"),t(\"p\",[s._v(\"什么是雪崩问题？\")]),s._v(\" \"),t(\"blockquote\",[t(\"p\",[s._v(\"微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。\")])]),s._v(\" \"),t(\"p\",[s._v(\"可以认为：\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"限流\")]),s._v(\"是对服务的保护，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。是一种\"),t(\"strong\",[s._v(\"预防\")]),s._v(\"措施。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"超时处理、线程隔离、降级熔断\")]),s._v(\"是在部分服务故障时，将故障控制在一定范围，避免雪崩。是一种\"),t(\"strong\",[s._v(\"补救\")]),s._v(\"措施。\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_1-2-服务保护技术对比\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-2-服务保护技术对比\"}},[s._v(\"#\")]),s._v(\" 1.2.服务保护技术对比\")]),s._v(\" \"),t(\"p\",[s._v(\"在SpringCloud当中支持多种服务保护技术：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"a\",{attrs:{href:\"https://github.com/Netflix/Hystrix\",target:\"_blank\",rel:\"noopener noreferrer\"}},[s._v(\"Netfix Hystrix\"),t(\"OutboundLink\")],1)]),s._v(\" \"),t(\"li\",[t(\"a\",{attrs:{href:\"https://github.com/alibaba/Sentinel\",target:\"_blank\",rel:\"noopener noreferrer\"}},[s._v(\"Sentinel\"),t(\"OutboundLink\")],1)]),s._v(\" \"),t(\"li\",[t(\"a\",{attrs:{href:\"https://github.com/resilience4j/resilience4j\",target:\"_blank\",rel:\"noopener noreferrer\"}},[s._v(\"Resilience4J\"),t(\"OutboundLink\")],1)])]),s._v(\" \"),t(\"p\",[s._v(\"早期比较流行的是Hystrix框架，但目前国内实用最广泛的还是阿里巴巴的Sentinel框架，\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_1-3-sentinel介绍和安装\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-3-sentinel介绍和安装\"}},[s._v(\"#\")]),s._v(\" 1.3.Sentinel介绍和安装\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_1-3-1-初识sentinel\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-3-1-初识sentinel\"}},[s._v(\"#\")]),s._v(\" 1.3.1.初识Sentinel\")]),s._v(\" \"),t(\"p\",[s._v(\"Sentinel是阿里巴巴开源的一款微服务流量控制组件。官网地址：https://sentinelguard.io/zh-cn/index.html\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_1-3-2-安装sentinel\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-3-2-安装sentinel\"}},[s._v(\"#\")]),s._v(\" 1.3.2.安装Sentinel\")]),s._v(\" \"),t(\"p\",[s._v(\"1）下载\")]),s._v(\" \"),t(\"p\",[s._v(\"sentinel官方提供了UI控制台，方便我们对系统做限流设置。大家可以在\"),t(\"a\",{attrs:{href:\"https://github.com/alibaba/Sentinel/releases\",target:\"_blank\",rel:\"noopener noreferrer\"}},[s._v(\"GitHub\"),t(\"OutboundLink\")],1),s._v(\"下载。\")]),s._v(\" \"),t(\"p\",[s._v(\"2）运行\")]),s._v(\" \"),t(\"p\",[s._v(\"将jar包放到任意非中文目录，执行命令：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-sh line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"java\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"-jar\")]),s._v(\" sentinel-dashboard-1.8.1.jar\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\")])]),t(\"p\",[s._v(\"如果要修改Sentinel的默认端口、账户、密码，可以通过下列配置：\")]),s._v(\" \"),t(\"table\",[t(\"thead\",[t(\"tr\",[t(\"th\",[t(\"strong\",[s._v(\"配置项\")])]),s._v(\" \"),t(\"th\",[t(\"strong\",[s._v(\"默认值\")])]),s._v(\" \"),t(\"th\",[t(\"strong\",[s._v(\"说明\")])])])]),s._v(\" \"),t(\"tbody\",[t(\"tr\",[t(\"td\",[s._v(\"server.port\")]),s._v(\" \"),t(\"td\",[s._v(\"8080\")]),s._v(\" \"),t(\"td\",[s._v(\"服务端口\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",[s._v(\"sentinel.dashboard.auth.username\")]),s._v(\" \"),t(\"td\",[s._v(\"sentinel\")]),s._v(\" \"),t(\"td\",[s._v(\"默认用户名\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",[s._v(\"sentinel.dashboard.auth.password\")]),s._v(\" \"),t(\"td\",[s._v(\"sentinel\")]),s._v(\" \"),t(\"td\",[s._v(\"默认密码\")])])])]),s._v(\" \"),t(\"p\",[s._v(\"例如，修改端口：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-sh line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"java\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"-Dserver.port\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"8090\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"-jar\")]),s._v(\" sentinel-dashboard-1.8.1.jar\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\")])]),t(\"p\",[s._v(\"3）访问\")]),s._v(\" \"),t(\"p\",[s._v(\"访问http://localhost:8080页面，就可以看到sentinel的控制台了：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715191134448.png\",alt:\"image-20210715190827846\"}})]),s._v(\" \"),t(\"p\",[s._v(\"需要输入账号和密码，默认都是：sentinel\")]),s._v(\" \"),t(\"p\",[s._v(\"登录后，发现一片空白，什么都没有：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715192010657.png\",alt:\"image-20210715191134448\"}})]),s._v(\" \"),t(\"p\",[s._v(\"这是因为我们还没有与微服务整合。\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_1-4-微服务整合sentinel\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-4-微服务整合sentinel\"}},[s._v(\"#\")]),s._v(\" 1.4.微服务整合Sentinel\")]),s._v(\" \"),t(\"p\",[s._v(\"我们在order-service中整合sentinel，并连接sentinel的控制台，步骤如下：\")]),s._v(\" \"),t(\"p\",[s._v(\"1）引入sentinel依赖\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-xml line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-xml\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"\\x3c!--sentinel--\\x3e\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"dependency\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"groupId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"com.alibaba.cloud\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"groupId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\" \\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"artifactId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"spring-cloud-starter-alibaba-sentinel\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"artifactId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"dependency\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\")])]),t(\"p\",[s._v(\"2）配置控制台\")]),s._v(\" \"),t(\"p\",[s._v(\"修改application.yaml文件，添加下面内容：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-yaml line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"server\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"port\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"8088\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spring\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"cloud\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"sentinel\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"transport\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"dashboard\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" localhost\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"8080\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\")])]),t(\"p\",[s._v(\"3）\"),t(\"strong\",[s._v(\"访问order-service的任意端点\")])]),s._v(\" \"),t(\"p\",[s._v(\"打开浏览器，访问http://localhost:8088/order/101，这样才能触发sentinel的监控。\")]),s._v(\" \"),t(\"p\",[s._v(\"然后再访问sentinel的控制台，查看效果：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715201827886.png\",alt:\"image-20210715191241799\"}})]),s._v(\" \"),t(\"h1\",{attrs:{id:\"_2-流量控制\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-流量控制\"}},[s._v(\"#\")]),s._v(\" 2.流量控制\")]),s._v(\" \"),t(\"p\",[s._v(\"雪崩问题虽然有四种方案，但是限流是避免服务因突发的流量而发生故障，是对微服务雪崩问题的预防。我们先学习这种模式。\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_2-1-簇点链路\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-1-簇点链路\"}},[s._v(\"#\")]),s._v(\" 2.1.簇点链路\")]),s._v(\" \"),t(\"p\",[s._v(\"当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的\"),t(\"strong\",[s._v(\"一个调用链\")]),s._v(\"就叫做\"),t(\"strong\",[s._v(\"簇点链路\")]),s._v(\"。簇点链路中被监控的每一个接口就是一个\"),t(\"strong\",[s._v(\"资源\")]),s._v(\"。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"默认情况下sentinel会监控SpringMVC的每一个端点（Endpoint，也就是controller中的方法），因此SpringMVC的每一个端点（Endpoint）就是调用链路中的一个资源。\")])]),s._v(\" \"),t(\"p\",[s._v(\"例如，我们刚才访问的order-service中的OrderController中的端点：/order/{orderId}\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715202540786.png\",alt:\"image-20210715191757319\"}})]),s._v(\" \"),t(\"p\",[s._v(\"流控、熔断等都是针对簇点链路中的资源来设置的，因此我们可以点击对应资源后面的按钮来设置规则：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"流控：流量控制\")]),s._v(\" \"),t(\"li\",[s._v(\"降级：降级熔断\")]),s._v(\" \"),t(\"li\",[s._v(\"热点：热点参数限流，是限流的一种\")]),s._v(\" \"),t(\"li\",[s._v(\"授权：请求的权限控制\")])]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_2-1-快速入门\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-1-快速入门\"}},[s._v(\"#\")]),s._v(\" 2.1.快速入门\")]),s._v(\" \"),t(\"p\",[s._v(\"点击资源/order/{orderId}后面的流控按钮，就可以弹出表单。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715202540786.png\",alt:\"image-20210715191757319\"}})]),s._v(\" \"),t(\"p\",[s._v(\"表单中可以填写限流规则，如下：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716101934499.png\",alt:\"image-20210715192010657\"}})]),s._v(\" \"),t(\"p\",[s._v(\"其含义是限制 /order/{orderId}这个资源的单机QPS为1，即每秒只允许1次请求，超出的请求会被拦截并报错。\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_2-2-流控模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-2-流控模式\"}},[s._v(\"#\")]),s._v(\" 2.2.流控模式\")]),s._v(\" \"),t(\"p\",[s._v(\"在添加限流规则时，点击高级选项，可以选择三种\"),t(\"strong\",[s._v(\"流控模式\")]),s._v(\"：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式\")]),s._v(\" \"),t(\"li\",[s._v(\"关联：\"),t(\"strong\",[s._v(\"统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流\")])]),s._v(\" \"),t(\"li\",[s._v(\"链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流\")])]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715191757319.png\",alt:\"image-20210715201827886\"}})]),s._v(\" \"),t(\"p\",[s._v(\"快速入门测试的就是直接模式。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_2-2-1-关联模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-2-1-关联模式\"}},[s._v(\"#\")]),s._v(\" 2.2.1.关联模式\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"关联模式\")]),s._v(\"：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"配置规则\")]),s._v(\"：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715191241799.png\",alt:\"image-20210715202540786\"}})]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"语法说明\")]),s._v(\"：当/write资源访问量触发阈值时，就会对/read资源限流，避免影响/write资源。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"使用场景\")]),s._v(\"：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。\"),t(\"strong\",[s._v(\"业务需求是优先支付\")]),s._v(\"和更新订单的业务，因此当修改订单业务触发阈值时，\"),t(\"strong\",[s._v(\"需要对查询订单业务限流。\")])]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"需求说明\")]),s._v(\"：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"在OrderController新建两个端点：/order/query和/order/update，无需实现业务\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"配置流控规则，当/order/ update资源被访问的QPS超过5时，对/order/query请求限流\")])])]),s._v(\" \"),t(\"p\",[s._v(\"1）定义/order/query端点，模拟订单查询\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@GetMapping\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/query\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"queryOrder\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"查询订单成功\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\")])]),t(\"p\",[s._v(\"2）定义/order/update端点，模拟订单更新\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@GetMapping\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/update\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"updateOrder\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"更新订单成功\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\")])]),t(\"p\",[s._v(\"重启服务，查看sentinel控制台的簇点链路：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716102416266.png\",alt:\"image-20210716101805951\"}})]),s._v(\" \"),t(\"p\",[s._v(\"3）配置流控规则\")]),s._v(\" \"),t(\"p\",[s._v(\"对哪个端点限流，就点击哪个端点后面的按钮。我们是对订单查询/order/query限流，因此点击它后面的按钮：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716101805951.png\",alt:\"image-20210716101934499\"}})]),s._v(\" \"),t(\"p\",[s._v(\"在表单中填写流控规则：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716102532554.png\",alt:\"image-20210716102103814\"}})]),s._v(\" \"),t(\"p\",[s._v(\"4）在Jmeter测试\")]),s._v(\" \"),t(\"p\",[s._v(\"选择《流控模式-关联》：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716103143002.png\",alt:\"image-20210716102416266\"}})]),s._v(\" \"),t(\"p\",[s._v(\"可以看到1000个用户，100秒，因此QPS为10，超过了我们设定的阈值：5\")]),s._v(\" \"),t(\"p\",[s._v(\"查看http请求：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716102636030.png\",alt:\"image-20210716102532554\"}})]),s._v(\" \"),t(\"p\",[s._v(\"请求的目标是/order/update，这样这个断点就会触发阈值。\")]),s._v(\" \"),t(\"p\",[s._v(\"但限流的目标是/order/query，我们在浏览器访问，可以发现：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716102103814.png\",alt:\"image-20210716102636030\"}})]),s._v(\" \"),t(\"p\",[s._v(\"确实被限流了。\")]),s._v(\" \"),t(\"p\",[s._v(\"5）总结\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716103536346.png\",alt:\"image-20210716103143002\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_2-2-2-链路模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-2-2-链路模式\"}},[s._v(\"#\")]),s._v(\" 2.2.2.链路模式\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"链路模式\")]),s._v(\"：只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"配置示例\")]),s._v(\"：\")]),s._v(\" \"),t(\"p\",[s._v(\"例如有两条请求链路：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"/test1 --\\x3e /common\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"/test2 --\\x3e /common\")])])]),s._v(\" \"),t(\"p\",[s._v(\"如果只希望统计从/test2进入到/common的请求，则可以这样配置：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716105227163.png\",alt:\"image-20210716103536346\"}})]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"实战案例\")])]),s._v(\" \"),t(\"p\",[s._v(\"需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。\")]),s._v(\" \"),t(\"p\",[s._v(\"步骤：\")]),s._v(\" \"),t(\"ol\",[t(\"li\",[t(\"p\",[s._v(\"在OrderService中添加一个queryGoods方法，不用实现业务\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"在OrderController中，改造/order/query端点，调用OrderService中的queryGoods方法\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"在OrderController中添加一个/order/save的端点，调用OrderService的queryGoods方法\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"给queryGoods设置限流规则，从/order/query进入queryGoods的方法限制QPS必须小于2\")])])]),s._v(\" \"),t(\"p\",[s._v(\"实现：\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_1-添加查询商品方法\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-添加查询商品方法\"}},[s._v(\"#\")]),s._v(\" 1）添加查询商品方法\")]),s._v(\" \"),t(\"p\",[s._v(\"在order-service服务中，给OrderService类添加一个queryGoods方法：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"void\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"queryGoods\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"System\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"err\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"println\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"查询商品\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\")])]),t(\"h4\",{attrs:{id:\"_2-查询订单时-查询商品\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-查询订单时-查询商品\"}},[s._v(\"#\")]),s._v(\" 2）查询订单时，查询商品\")]),s._v(\" \"),t(\"p\",[s._v(\"在order-service的OrderController中，修改/order/query端点的业务逻辑：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@GetMapping\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/query\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"queryOrder\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 查询商品\")]),s._v(\"\\n    orderService\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"queryGoods\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 查询订单\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"System\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"out\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"println\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"查询订单\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"查询订单成功\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\")])]),t(\"h4\",{attrs:{id:\"_3-新增订单-查询商品\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-新增订单-查询商品\"}},[s._v(\"#\")]),s._v(\" 3）新增订单，查询商品\")]),s._v(\" \"),t(\"p\",[s._v(\"在order-service的OrderController中，修改/order/save端点，模拟新增订单：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@GetMapping\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/save\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"saveOrder\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 查询商品\")]),s._v(\"\\n    orderService\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"queryGoods\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 查询订单\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"System\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"err\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"println\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"新增订单\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"新增订单成功\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\")])]),t(\"h4\",{attrs:{id:\"_4-给查询商品添加资源标记\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-给查询商品添加资源标记\"}},[s._v(\"#\")]),s._v(\" 4）给查询商品添加资源标记\")]),s._v(\" \"),t(\"p\",[s._v(\"默认情况下，\"),t(\"strong\",[s._v(\"OrderService中的方法是不被Sentinel监控的，需要我们自己通过注解来标记要监控的方法。\")])]),s._v(\" \"),t(\"p\",[s._v(\"给OrderService的queryGoods方法添加**@SentinelResource注解**：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@SentinelResource\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"goods\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"void\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"queryGoods\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"System\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"err\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"println\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"查询商品\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\")])]),t(\"p\",[s._v(\"链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。\")]),s._v(\" \"),t(\"p\",[s._v(\"我们需要\"),t(\"strong\",[s._v(\"关闭这种对SpringMVC的资源聚合\")]),s._v(\"，修改order-service服务的application.yml文件：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-yaml line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spring\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"cloud\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"sentinel\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"web-context-unify\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token boolean important\"}},[s._v(\"false\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 关闭context整合\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\")])]),t(\"p\",[s._v(\"重启服务，访问/order/query和/order/save，可以查看到sentinel的簇点链路规则中，出现了新的资源：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716105812789.png\",alt:\"image-20210716105227163\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_5-添加流控规则\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-添加流控规则\"}},[s._v(\"#\")]),s._v(\" 5）添加流控规则\")]),s._v(\" \"),t(\"p\",[s._v(\"点击goods资源后面的流控按钮，在弹出的表单中填写下面信息：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716105408723.png\",alt:\"image-20210716105408723\"}})]),s._v(\" \"),t(\"p\",[s._v(\"只统计从/order/query进入/goods的资源，QPS阈值为2，超出则被限流。\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_6-jmeter测试\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_6-jmeter测试\"}},[s._v(\"#\")]),s._v(\" 6）Jmeter测试\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716105855951.png\",alt:\"image-20210716105612312\"}})]),s._v(\" \"),t(\"p\",[s._v(\"可以看到这里200个用户，50秒内发完，QPS为4，超过了我们设定的阈值2\")]),s._v(\" \"),t(\"p\",[s._v(\"一个http请求是访问/order/save：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716105612312.png\",alt:\"image-20210716105812789\"}})]),s._v(\" \"),t(\"p\",[s._v(\"运行的结果：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716110027064.png\",alt:\"image-20210716110027064\"}})]),s._v(\" \"),t(\"p\",[s._v(\"完全不受影响。\")]),s._v(\" \"),t(\"p\",[s._v(\"另一个是访问/order/query：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716110225104.png\",alt:\"image-20210716105855951\"}})]),s._v(\" \"),t(\"p\",[s._v(\"运行结果：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716105956401.png\",alt:\"image-20210716105956401\"}})]),s._v(\" \"),t(\"p\",[s._v(\"每次只有2个通过。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_2-2-3-总结\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-2-3-总结\"}},[s._v(\"#\")]),s._v(\" 2.2.3.总结\")]),s._v(\" \"),t(\"p\",[s._v(\"流控模式有哪些？\")]),s._v(\" \"),t(\"p\",[s._v(\"•直接：对当前资源限流\")]),s._v(\" \"),t(\"p\",[s._v(\"•关联：高优先级资源触发阈值，对低优先级资源限流。\")]),s._v(\" \"),t(\"p\",[s._v(\"•链路：阈值统计时，只统计从指定资源进入当前资源的请求，是对请求来源的限流\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_2-3-流控效果\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-3-流控效果\"}},[s._v(\"#\")]),s._v(\" 2.3.流控效果\")]),s._v(\" \"),t(\"p\",[s._v(\"在流控的高级选项中，还有一个流控效果选项：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716110629796.png\",alt:\"image-20210716110225104\"}})]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"流控效果\")]),s._v(\"是指请求达到流控阈值时应该采取的措施，包括三种：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"快速失败：达到阈值后，\"),t(\"strong\",[s._v(\"新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。\")])])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常。\"),t(\"strong\",[s._v(\"但这种模式阈值会动态变化，从一个较小值逐渐增加到最大阈值。\")])])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"排队等待：让所有的请求按照先后次序排队执行，两个请求的间隔不能小于指定时长\")])])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_2-3-1-warm-up\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-3-1-warm-up\"}},[s._v(\"#\")]),s._v(\" 2.3.1.warm up\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"阈值一般是一个微服务能承担的最大QPS\")]),s._v(\"，但是一个服务刚刚启动时，一切资源尚未初始化（\"),t(\"strong\",[s._v(\"冷启动\")]),s._v(\"），如果直接将QPS跑到最大值，可能导致服务瞬间宕机。\")]),s._v(\" \"),t(\"p\",[s._v(\"warm up也叫\"),t(\"strong\",[s._v(\"预热模式\")]),s._v(\"，是应对服务冷启动的一种方案。请求阈值初始值是 \"),t(\"strong\",[s._v(\"maxThreshold（最大QPS）\")]),s._v(\" / coldFactor，持续指定时长后，逐渐提高到maxThreshold值。而\"),t(\"strong\",[s._v(\"coldFactor的默认值是3\")]),s._v(\".\")]),s._v(\" \"),t(\"p\",[s._v(\"例如，我设置QPS的maxThreshold为10，预热时间为5秒，那么初始阈值就是 10 / 3 ，也就是3，\"),t(\"strong\",[s._v(\"然后在5秒后逐渐增长到10.\")])]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716111136699.png\",alt:\"image-20210716110629796\"}})]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"案例\")])]),s._v(\" \"),t(\"p\",[s._v(\"需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用warm up效果，预热时长为5秒\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_1-配置流控规则\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-配置流控规则\"}},[s._v(\"#\")]),s._v(\" 1）配置流控规则：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716111012387.png\",alt:\"image-20210716111012387\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_2-jmeter测试\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-jmeter测试\"}},[s._v(\"#\")]),s._v(\" 2）Jmeter测试\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716111303701.png\",alt:\"image-20210716111136699\"}})]),s._v(\" \"),t(\"p\",[s._v(\"QPS为10.\")]),s._v(\" \"),t(\"p\",[s._v(\"刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716113147176.png\",alt:\"image-20210716111303701\"}})]),s._v(\" \"),t(\"p\",[s._v(\"随着时间推移，成功比例越来越高：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716113426524.png\",alt:\"image-20210716111404717\"}})]),s._v(\" \"),t(\"p\",[s._v(\"到Sentinel控制台查看实时监控：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716111404717.png\",alt:\"image-20210716111526480\"}})]),s._v(\" \"),t(\"p\",[s._v(\"一段时间后：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716111658541.png\",alt:\"image-20210716111658541\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_2-3-2-排队等待\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-3-2-排队等待\"}},[s._v(\"#\")]),s._v(\" 2.3.2.排队等待\")]),s._v(\" \"),t(\"p\",[s._v(\"当请求超过QPS阈值时，快速失败和warm up 会拒绝新的请求并抛出异常。\")]),s._v(\" \"),t(\"p\",[s._v(\"而排队等待则是让所有请求进入一个队列中，\"),t(\"strong\",[s._v(\"然后按照阈值允许的时间间隔依次执行\")]),s._v(\"。后来的请求必须等待前面执行完成，如果请求预期的等待时间超出最大时长，则会被拒绝。\")]),s._v(\" \"),t(\"p\",[s._v(\"工作原理\")]),s._v(\" \"),t(\"p\",[s._v(\"例如：QPS = 5，意味着每200ms处理一个队列中的请求；timeout = 2000，意味着\"),t(\"strong\",[s._v(\"预期等待时长\")]),s._v(\"超过2000ms的请求会被拒绝并抛出异常。\")]),s._v(\" \"),t(\"p\",[s._v(\"那什么叫做预期等待时长呢？\")]),s._v(\" \"),t(\"p\",[s._v(\"比如现在一下子来了12 个请求，因为每200ms执行一个请求，那么：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"第6个请求的\"),t(\"strong\",[s._v(\"预期等待时长\")]),s._v(\" =  200 * （6 - 1） = 1000ms\")]),s._v(\" \"),t(\"li\",[s._v(\"第12个请求的预期等待时长 = 200 * （12-1） = 2200ms\")])]),s._v(\" \"),t(\"p\",[s._v(\"现在，第1秒同时接收到10个请求，但第2秒只有1个请求，此时QPS的曲线这样的：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716111526480.png\",alt:\"image-20210716113147176\"}})]),s._v(\" \"),t(\"p\",[s._v(\"如果使用队列模式做流控，所有进入的请求都要排队，以固定的200ms的间隔执行，\"),t(\"strong\",[s._v(\"QPS会变的很平滑\")]),s._v(\"：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716114243558.png\",alt:\"image-20210716113426524\"}})]),s._v(\" \"),t(\"p\",[s._v(\"平滑的QPS曲线，对于服务器来说是更友好的。（起到了流量削峰的作用）\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"案例\")])]),s._v(\" \"),t(\"p\",[s._v(\"需求：给/order/{orderId}这个资源设置限流，最大QPS为10，利用排队的流控效果，超时时长设置为5s\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_1-添加流控规则\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-添加流控规则\"}},[s._v(\"#\")]),s._v(\" 1）添加流控规则\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716114048918.png\",alt:\"image-20210716114048918\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_2-jmeter测试-2\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-jmeter测试-2\"}},[s._v(\"#\")]),s._v(\" 2）Jmeter测试\")]),s._v(\" \"),t(\"p\",[s._v(\"选择《流控效果，队列》：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716114522935.png\",alt:\"image-20210716114243558\"}})]),s._v(\" \"),t(\"p\",[s._v(\"QPS为15，已经超过了我们设定的10。\")]),s._v(\" \"),t(\"p\",[s._v(\"如果是之前的 快速失败、warmup模式，超出的请求应该会直接报错。\")]),s._v(\" \"),t(\"p\",[s._v(\"但是我们看看队列模式的运行结果：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716115014663.png\",alt:\"image-20210716114429361\"}})]),s._v(\" \"),t(\"p\",[s._v(\"全部都通过了。\")]),s._v(\" \"),t(\"p\",[s._v(\"再去sentinel查看实时监控的QPS曲线：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716115131463.png\",alt:\"image-20210716114522935\"}})]),s._v(\" \"),t(\"p\",[s._v(\"QPS非常平滑，一致保持在10，但是\"),t(\"strong\",[s._v(\"超出的请求没有被拒绝，而是放入队列   （成功率也提升了） \"),t(\"strong\",[s._v(\"。因此\")]),s._v(\"响应时间\")]),s._v(\"（等待时间）会越来越长。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"当队列满了以后，才会有部分请求失败\")]),s._v(\"：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716114429361.png\",alt:\"image-20210716114651137\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_2-3-3-总结\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-3-3-总结\"}},[s._v(\"#\")]),s._v(\" 2.3.3.总结\")]),s._v(\" \"),t(\"p\",[s._v(\"流控效果有哪些？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"快速失败：QPS超过阈值时，拒绝新的请求\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"warm up： QPS超过阈值时，拒绝新的请求；QPS阈值是逐渐提升的，可以避免冷启动时高并发导致服务宕机。\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"排队等待：请求会进入队列，按照阈值允许的时间间隔依次执行请求；如果请求预期等待时长大于超时时间，直接拒绝\")])])]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_2-4-热点参数限流\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-4-热点参数限流\"}},[s._v(\"#\")]),s._v(\" 2.4.热点参数限流\")]),s._v(\" \"),t(\"p\",[s._v(\"之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是\"),t(\"strong\",[s._v(\"分别统计参数值相同的请求\")]),s._v(\"，判断是否超过QPS阈值。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_2-4-1-全局参数限流\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-4-1-全局参数限流\"}},[s._v(\"#\")]),s._v(\" 2.4.1.全局参数限流\")]),s._v(\" \"),t(\"p\",[s._v(\"例如，一个根据id查询商品的接口：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716114651137.png\",alt:\"image-20210716115014663\"}})]),s._v(\" \"),t(\"p\",[s._v(\"访问/goods/{id}的请求中，id参数值会有变化，热点参数限流会根据参数值分别统计QPS，统计结果：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716115717523.png\",alt:\"image-20210716115131463\"}})]),s._v(\" \"),t(\"p\",[s._v(\"当id=1的请求触发阈值被限流时，id值不为1的请求不受影响。\")]),s._v(\" \"),t(\"p\",[s._v(\"配置示例：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716122403502.png\",alt:\"image-20210716115232426\"}})]),s._v(\" \"),t(\"p\",[s._v(\"代表的含义是：对hot这个资源的0号参数（第一个参数）做统计，每1秒\"),t(\"strong\",[s._v(\"相同参数值\")]),s._v(\"的请求数不能超过5\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_2-4-2-热点参数限流\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-4-2-热点参数限流\"}},[s._v(\"#\")]),s._v(\" 2.4.2.热点参数限流\")]),s._v(\" \"),t(\"p\",[s._v(\"刚才的配置中，对查询商品这个接口的所有商品一视同仁，QPS都限定为5.\")]),s._v(\" \"),t(\"p\",[s._v(\"而在实际开发中，可能部分商品是热点商品，例如秒杀商品，我们希望这部分商品的QPS限制与其它商品不一样，高一些。那就需要配置热点参数限流的\"),t(\"strong\",[s._v(\"高级选项\")]),s._v(\"了：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716115232426.png\",alt:\"image-20210716115717523\"}})]),s._v(\" \"),t(\"p\",[s._v(\"结合上一个配置，这里的含义是对0号的long类型参数限流，每1秒相同参数的QPS不能超过5，有两个例外：\")]),s._v(\" \"),t(\"p\",[s._v(\"•如果参数值是100，则每1秒允许的QPS为10\")]),s._v(\" \"),t(\"p\",[s._v(\"•如果参数值是101，则每1秒允许的QPS为15\")]),s._v(\" \"),t(\"h1\",{attrs:{id:\"_3-隔离和降级\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-隔离和降级\"}},[s._v(\"#\")]),s._v(\" 3.隔离和降级\")]),s._v(\" \"),t(\"p\",[s._v(\"限流是\"),t(\"strong\",[s._v(\"一种预防措施\")]),s._v(\"，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"这里讲的是如何应对服务宕机的情况\")])]),s._v(\" \"),t(\"p\",[s._v(\"而要将这些故障控制在一定范围，避免雪崩，就要靠\"),t(\"strong\",[s._v(\"线程隔离\")]),s._v(\"（舱壁模式）和\"),t(\"strong\",[s._v(\"熔断降级\")]),s._v(\"手段了。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"线程隔离\")]),s._v(\"之前讲到过：调用者在调用服务提供者时，给每个调用的请求分配独立线程池，出现故障时，最多消耗这个线程池内资源，避免把调用者的所有资源耗尽。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715173428073.png\",alt:\"image-20210715173215243\"}})]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"熔断降级\")]),s._v(\"：是在调用方这边加入断路器，统计对服务提供者的调用，如果调用的失败比例过高，则熔断该业务，不允许访问该服务的提供者了。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210715190827846.png\",alt:\"image-20210715173428073\"}})]),s._v(\" \"),t(\"p\",[s._v(\"可以看到，不管是线程隔离还是熔断降级，都是对\"),t(\"strong\",[s._v(\"客户端\")]),s._v(\"（调用方）的保护。需要在\"),t(\"strong\",[s._v(\"调用方\")]),s._v(\" 发起远程调用时做线程隔离、或者服务熔断。\")]),s._v(\" \"),t(\"p\",[s._v(\"而我们的微服务远程调用都是基于Feign来完成的，因此我们需要将\"),t(\"strong\",[s._v(\"Feign与Sentinel整合\")]),s._v(\"，在Feign里面实现线程隔离和服务熔断。\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_3-1-feignclient整合sentinel\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-1-feignclient整合sentinel\"}},[s._v(\"#\")]),s._v(\" 3.1.FeignClient整合Sentinel\")]),s._v(\" \"),t(\"p\",[s._v(\"SpringCloud中，微服务调用都是通过Feign来实现的，因此做客户端保护必须整合Feign和Sentinel。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_3-1-1-修改配置-开启sentinel功能\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-1-1-修改配置-开启sentinel功能\"}},[s._v(\"#\")]),s._v(\" 3.1.1.修改配置，开启sentinel功能\")]),s._v(\" \"),t(\"p\",[s._v(\"修改OrderService的application.yml文件，开启Feign的Sentinel功能：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-yaml line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"feign\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"sentinel\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"enabled\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token boolean important\"}},[s._v(\"true\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 开启feign对sentinel的支持\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\")])]),t(\"h3\",{attrs:{id:\"_3-1-2-编写失败降级逻辑\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-1-2-编写失败降级逻辑\"}},[s._v(\"#\")]),s._v(\" 3.1.2.编写失败降级逻辑\")]),s._v(\" \"),t(\"p\",[s._v(\"业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。\")]),s._v(\" \"),t(\"p\",[s._v(\"给FeignClient编写失败后的降级逻辑\")]),s._v(\" \"),t(\"p\",[s._v(\"①方式一：\"),t(\"code\",[s._v(\"FallbackClass\")]),s._v(\"，无法对远程调用的异常做处理\")]),s._v(\" \"),t(\"p\",[s._v(\"②方式二：\"),t(\"code\",[s._v(\"FallbackFactory\")]),s._v(\"，可以对远程调用的异常做处理，我们选择这种\")]),s._v(\" \"),t(\"p\",[s._v(\"这里我们演示方式二的失败降级处理。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"步骤一\")]),s._v(\"：在feing-api项目中定义类，实现FallbackFactory：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716123411217.png\",alt:\"image-20210716122403502\"}})]),s._v(\" \"),t(\"p\",[s._v(\"代码：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"package\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"feign\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"clients\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"fallback\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"feign\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"clients\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"UserClient\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"feign\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"pojo\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"User\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"feign\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"hystrix\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"FallbackFactory\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"lombok\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"extern\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"slf4j\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Slf4j\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Slf4j\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"class\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"UserClientFallbackFactory\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"implements\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"FallbackFactory\")]),t(\"span\",{pre:!0,attrs:{class:\"token generics\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"UserClient\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 返回接口   写错误逻辑\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Override\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"UserClient\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"create\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Throwable\")]),s._v(\" throwable\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"new\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"UserClient\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n            \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Override\")]),s._v(\"\\n            \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"User\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"findById\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Long\")]),s._v(\" id\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n                log\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"error\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"查询用户异常\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" throwable\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"//记录日志\")]),s._v(\"\\n                \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"new\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"User\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\t\\t\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 返回个空对象\")]),s._v(\"\\n            \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"17\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"18\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"19\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"20\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"21\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"22\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"23\")]),t(\"br\")])]),t(\"p\",[t(\"strong\",[s._v(\"步骤二\")]),s._v(\"：在feing-api项目中的DefaultFeignConfiguration类中将UserClientFallbackFactory注册为一个Bean：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Bean\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"UserClientFallbackFactory\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"userClientFallbackFactory\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"new\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"UserClientFallbackFactory\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\")])]),t(\"p\",[t(\"strong\",[s._v(\"步骤三\")]),s._v(\"：在feing-api项目中的UserClient接口中使用UserClientFallbackFactory：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"feign\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"clients\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"fallback\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"UserClientFallbackFactory\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"feign\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"pojo\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"User\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"org\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"springframework\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"cloud\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"openfeign\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"FeignClient\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"org\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"springframework\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"web\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"bind\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"annotation\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"GetMapping\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"org\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"springframework\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"web\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"bind\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"annotation\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"PathVariable\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@FeignClient\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"value \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"userservice\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" fallbackFactory \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"UserClientFallbackFactory\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"class\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"interface\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"UserClient\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@GetMapping\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"/user/{id}\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"User\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"findById\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@PathVariable\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"id\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Long\")]),s._v(\" id\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\")])]),t(\"p\",[s._v(\"重启后，访问一次订单查询业务，然后查看sentinel控制台，可以看到新的簇点链路：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716123036937.png\",alt:\"image-20210716123705780\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_3-1-3-总结\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-1-3-总结\"}},[s._v(\"#\")]),s._v(\" 3.1.3.总结\")]),s._v(\" \"),t(\"p\",[s._v(\"Sentinel支持的雪崩解决方案：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"线程隔离（仓壁模式）\")]),s._v(\" \"),t(\"li\",[s._v(\"降级熔断\")])]),s._v(\" \"),t(\"p\",[s._v(\"Feign整合Sentinel的步骤：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"在application.yml中配置：feign.sentienl.enable=true\")]),s._v(\" \"),t(\"li\",[s._v(\"给FeignClient编写FallbackFactory并注册为Bean\")]),s._v(\" \"),t(\"li\",[s._v(\"将FallbackFactory配置到FeignClient\")])]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_3-2-线程隔离-舱壁模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-2-线程隔离-舱壁模式\"}},[s._v(\"#\")]),s._v(\" 3.2.线程隔离（舱壁模式）\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_3-2-1-线程隔离的实现方式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-2-1-线程隔离的实现方式\"}},[s._v(\"#\")]),s._v(\" 3.2.1.线程隔离的实现方式\")]),s._v(\" \"),t(\"p\",[s._v(\"线程隔离有两种方式实现：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"线程池隔离\")])])]),s._v(\" \"),t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"信号量隔离（Sentinel默认采用）\")])])])]),s._v(\" \"),t(\"p\",[s._v(\"如图：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716123705780.png\",alt:\"image-20210716123036937\"}})]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"线程池隔离\")]),s._v(\"：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"信号量隔离\")]),s._v(\"：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。\")]),s._v(\" \"),t(\"p\",[s._v(\"两者的优缺点：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716123831992.png\",alt:\"image-20210716123240518\"}})]),s._v(\" \"),t(\"blockquote\",[t(\"p\",[s._v(\"扇出：fanout\")]),s._v(\" \"),t(\"p\",[s._v(\"类似于扩散的意思   比如说一个服务依赖了其他很多个服务，就叫做高扇出\")]),s._v(\" \"),t(\"p\",[s._v(\"因此，高扇出的肯定是不适合用线程池的，第一是要开很多个线程池，第二是上下文切换啊  内存的占用啊都很多\")])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_3-2-2-sentinel的线程隔离\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-2-2-sentinel的线程隔离\"}},[s._v(\"#\")]),s._v(\" 3.2.2.sentinel的线程隔离\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"用法说明\")]),s._v(\"：\")]),s._v(\" \"),t(\"p\",[s._v(\"在添加限流规则时，可以选择两种阈值类型：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716123240518.png\",alt:\"image-20210716123411217\"}})]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"QPS：就是每秒的请求数，在快速入门中已经演示过\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"线程数：是该资源能使用用的tomcat线程数的最大值。也就是通过限制线程数量，实现\"),t(\"strong\",[s._v(\"线程隔离\")]),s._v(\"（舱壁模式）。\")])])]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"案例需求\")]),s._v(\"：给 order-service服务中的UserClient的查询用户接口设置流控规则，线程数不能超过 2。然后利用jemeter测试。\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_1-配置隔离规则\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-配置隔离规则\"}},[s._v(\"#\")]),s._v(\" 1）配置隔离规则\")]),s._v(\" \"),t(\"p\",[s._v(\"选择feign接口后面的流控按钮：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716124229894.png\",alt:\"image-20210716123831992\"}})]),s._v(\" \"),t(\"p\",[s._v(\"填写表单：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716123936844.png\",alt:\"image-20210716123936844\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"_2-jmeter测试-3\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-jmeter测试-3\"}},[s._v(\"#\")]),s._v(\" 2）Jmeter测试\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716130958518.png\",alt:\"image-20210716124229894\"}})]),s._v(\" \"),t(\"p\",[s._v(\"一次发生10个请求，有较大概率并发线程数超过2，而超出的请求会走之前定义的失败降级逻辑。\")]),s._v(\" \"),t(\"p\",[s._v(\"查看运行结果：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716131430682.png\",alt:\"image-20210716124147820\"}})]),s._v(\" \"),t(\"p\",[s._v(\"发现虽然结果都是通过了，不过部分请求得到的响应是降级返回的null信息。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_3-2-3-总结\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-2-3-总结\"}},[s._v(\"#\")]),s._v(\" 3.2.3.总结\")]),s._v(\" \"),t(\"p\",[s._v(\"线程隔离的两种手段是？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"信号量隔离\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"线程池隔离\")])])]),s._v(\" \"),t(\"p\",[s._v(\"信号量隔离的特点是？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"基于计数器模式，简单，开销小\")])]),s._v(\" \"),t(\"p\",[s._v(\"线程池隔离的特点是？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"基于线程池模式，有额外开销，但隔离控制更强\")])]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_3-3-熔断降级\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-3-熔断降级\"}},[s._v(\"#\")]),s._v(\" 3.3.熔断降级\")]),s._v(\" \"),t(\"p\",[s._v(\"熔断降级是解决雪崩问题的重要手段。其思路是由\"),t(\"strong\",[s._v(\"断路器\")]),s._v(\"统计服务调用的异常比例、慢请求比例，如果超出阈值则会\"),t(\"strong\",[s._v(\"熔断\")]),s._v(\"该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。\")]),s._v(\" \"),t(\"p\",[s._v(\"断路器控制熔断和放行是通过\"),t(\"strong\",[s._v(\"状态机\")]),s._v(\"来完成的：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716145934347.png\",alt:\"image-20210716130958518\"}})]),s._v(\" \"),t(\"p\",[s._v(\"状态机包括三个状态：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态\")]),s._v(\" \"),t(\"li\",[s._v(\"open：打开状态，服务调用被\"),t(\"strong\",[s._v(\"熔断\")]),s._v(\"，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态\")]),s._v(\" \"),t(\"li\",[s._v(\"half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。\\n\"),t(\"ul\",[t(\"li\",[s._v(\"请求成功：则切换到closed状态\")]),s._v(\" \"),t(\"li\",[s._v(\"请求失败：则切换到open状态\")])])])]),s._v(\" \"),t(\"p\",[s._v(\"断路器熔断策略有三种：慢调用、异常比例、异常数\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_3-3-1-慢调用\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-3-1-慢调用\"}},[s._v(\"#\")]),s._v(\" 3.3.1.慢调用\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"慢调用\")]),s._v(\"：业务的响应时长（\"),t(\"strong\",[s._v(\"RT  response time\")]),s._v(\"）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。\")]),s._v(\" \"),t(\"p\",[s._v(\"例如：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716131522912.png\",alt:\"image-20210716145934347\"}})]),s._v(\" \"),t(\"p\",[s._v(\"解读：RT超过500ms的调用是慢调用，统计最近10000ms内的请求，如果请求量超过10次，并且慢调用比例不低于0.5，则触发熔断，熔断时长为5秒。然后进入half-open状态，放行一次请求做测试。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_3-3-2-异常比例、异常数\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-3-2-异常比例、异常数\"}},[s._v(\"#\")]),s._v(\" 3.3.2.异常比例、异常数\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"异常比例或异常数\")]),s._v(\"：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。\")]),s._v(\" \"),t(\"p\",[s._v(\"例如，一个异常比例设置：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716124147820.png\",alt:\"image-20210716131430682\"}})]),s._v(\" \"),t(\"p\",[s._v(\"解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于0.4，则触发熔断。\")]),s._v(\" \"),t(\"p\",[s._v(\"一个异常数设置：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716152010750.png\",alt:\"image-20210716131522912\"}})]),s._v(\" \"),t(\"p\",[s._v(\"解读：统计最近1000ms内的请求，如果请求量超过10次，并且异常比例不低于2次，则触发熔断。\")]),s._v(\" \"),t(\"h1\",{attrs:{id:\"_4-授权规则\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-授权规则\"}},[s._v(\"#\")]),s._v(\" 4.授权规则\")]),s._v(\" \"),t(\"p\",[s._v(\"授权规则可以对请求方来源做判断和控制。\"),t(\"strong\",[s._v(\"(之前的微服务是一直走网关的   这里是应对比如说服务泄露导致有些请求不走网关的情况)\")])]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_4-1-授权规则\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-1-授权规则\"}},[s._v(\"#\")]),s._v(\" 4.1.授权规则\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_4-1-1-基本规则\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-1-1-基本规则\"}},[s._v(\"#\")]),s._v(\" 4.1.1.基本规则\")]),s._v(\" \"),t(\"p\",[s._v(\"授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"白名单：来源（origin）在白名单内的调用者允许访问\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"黑名单：来源（origin）在黑名单内的调用者不允许访问\")])])]),s._v(\" \"),t(\"p\",[s._v(\"点击左侧菜单的授权，可以看到授权规则：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716152349191.png\",alt:\"image-20210716152010750\"}})]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"资源名：就是受保护的资源，例如/order/{orderId}\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"流控应用：是来源者的名单，\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"如果是勾选白名单，则名单中的来源被许可访问。\")]),s._v(\" \"),t(\"li\",[s._v(\"如果是勾选黑名单，则名单中的来源被禁止访问。\")])])])]),s._v(\" \"),t(\"p\",[s._v(\"比如：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716153348396.png\",alt:\"image-20210716152349191\"}})]),s._v(\" \"),t(\"p\",[s._v(\"我们允许请求从gateway到order-service，不允许浏览器访问order-service，那么白名单中就要填写\"),t(\"strong\",[s._v(\"网关的来源名称（origin）\")]),s._v(\"。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_4-1-2-如何获取origin\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-1-2-如何获取origin\"}},[s._v(\"#\")]),s._v(\" 4.1.2.如何获取origin\")]),s._v(\" \"),t(\"p\",[s._v(\"Sentinel是通过\"),t(\"code\",[s._v(\"RequestOriginParser\")]),s._v(\"这个接口的\"),t(\"code\",[s._v(\"parseOrigin\")]),s._v(\"来获取请求的来源的。\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"interface\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"RequestOriginParser\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"/**\\n     * 从请求request对象中获取origin，获取方式自定义\\n     */\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"parseOrigin\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"HttpServletRequest\")]),s._v(\" request\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\")])]),t(\"p\",[s._v(\"这个方法的作用就是从request对象中，获取请求者的origin值并返回。\")]),s._v(\" \"),t(\"p\",[s._v(\"默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。\")]),s._v(\" \"),t(\"p\",[s._v(\"因此，我们需要自定义这个接口的实现，让\"),t(\"strong\",[s._v(\"不同的请求，返回不同的origin\")]),s._v(\"。\")]),s._v(\" \"),t(\"p\",[s._v(\"例如order-service服务中，我们定义一个RequestOriginParser的实现类：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"package\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"order\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"sentinel\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"com\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"alibaba\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"csp\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"sentinel\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"adapter\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"spring\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"webmvc\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"callback\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"RequestOriginParser\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"org\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"springframework\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"stereotype\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Component\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"org\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"springframework\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"util\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"StringUtils\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"javax\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"servlet\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"http\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"HttpServletRequest\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Component\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"class\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"HeaderOriginParser\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"implements\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"RequestOriginParser\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Override\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"parseOrigin\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"HttpServletRequest\")]),s._v(\" request\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 1.获取请求头\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" origin \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" request\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"getHeader\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"origin\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 2.非空判断\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"if\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"StringUtils\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"isEmpty\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"origin\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n            origin \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"blank\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" origin\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"17\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"18\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"19\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"20\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"21\")]),t(\"br\")])]),t(\"p\",[s._v(\"我们会尝试从request-header中获取origin值。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_4-1-3-给网关添加请求头\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-1-3-给网关添加请求头\"}},[s._v(\"#\")]),s._v(\" 4.1.3.给网关添加请求头\")]),s._v(\" \"),t(\"p\",[s._v(\"既然获取请求origin的方式是从reques-header中获取origin值，我们必须让\"),t(\"strong\",[s._v(\"所有从gateway路由到微服务的请求都带上origin头\")]),s._v(\"。\")]),s._v(\" \"),t(\"p\",[s._v(\"这个需要利用之前学习的一个GatewayFilter来实现，AddRequestHeaderGatewayFilter。\")]),s._v(\" \"),t(\"p\",[s._v(\"修改gateway服务中的application.yml，添加一个defaultFilter：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-yaml line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"spring\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"cloud\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"gateway\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"default-filters\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\" AddRequestHeader=origin\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\"gateway\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"routes\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n       \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# ...略\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\")])]),t(\"p\",[s._v(\"这样，从gateway路由的所有请求都会\"),t(\"strong\",[s._v(\"带上origin头，值为gateway。而从其它地方到达微服务的请求则没有这个头。\")])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_4-1-4-配置授权规则\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-1-4-配置授权规则\"}},[s._v(\"#\")]),s._v(\" 4.1.4.配置授权规则\")]),s._v(\" \"),t(\"p\",[s._v(\"接下来，我们添加一个授权规则，放行origin值为gateway的请求。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716153250134.png\",alt:\"image-20210716153250134\"}})]),s._v(\" \"),t(\"p\",[s._v(\"配置如下：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716153938887.png\",alt:\"image-20210716153301069\"}})]),s._v(\" \"),t(\"p\",[s._v(\"现在，我们直接跳过网关，访问order-service服务：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716153301069.png\",alt:\"image-20210716153348396\"}})]),s._v(\" \"),t(\"p\",[s._v(\"通过网关访问：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716154215456.png\",alt:\"image-20210716153434095\"}})]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_4-2-自定义异常结果\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-2-自定义异常结果\"}},[s._v(\"#\")]),s._v(\" 4.2.自定义异常结果\")]),s._v(\" \"),t(\"p\",[s._v(\"默认情况下，\"),t(\"strong\",[s._v(\"发生限流、降级、授权拦截时，都会抛出异常到调用方。异常结果都是flow limmiting（限流）\")]),s._v(\"。这样不够友好，无法得知是限流还是降级还是授权拦截。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_4-2-1-异常类型\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-2-1-异常类型\"}},[s._v(\"#\")]),s._v(\" 4.2.1.异常类型\")]),s._v(\" \"),t(\"p\",[s._v(\"而如果要自定义异常时的返回结果，需要实现BlockExceptionHandler接口：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"interface\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BlockExceptionHandler\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"/**\\n     * 处理请求被限流、降级、授权拦截时抛出的异常：BlockException\\n     */\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"void\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"handle\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"HttpServletRequest\")]),s._v(\" request\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"HttpServletResponse\")]),s._v(\" response\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BlockException\")]),s._v(\" e\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"throws\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Exception\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\")])]),t(\"p\",[s._v(\"这个方法有三个参数：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"HttpServletRequest request：request对象\")]),s._v(\" \"),t(\"li\",[s._v(\"HttpServletResponse response：response对象\")]),s._v(\" \"),t(\"li\",[s._v(\"BlockException e：被sentinel拦截时抛出的异常\")])]),s._v(\" \"),t(\"p\",[s._v(\"这里的BlockException包含多个不同的子类：\")]),s._v(\" \"),t(\"table\",[t(\"thead\",[t(\"tr\",[t(\"th\",[t(\"strong\",[s._v(\"异常\")])]),s._v(\" \"),t(\"th\",[t(\"strong\",[s._v(\"说明\")])])])]),s._v(\" \"),t(\"tbody\",[t(\"tr\",[t(\"td\",[s._v(\"FlowException\")]),s._v(\" \"),t(\"td\",[s._v(\"限流异常\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",[s._v(\"ParamFlowException\")]),s._v(\" \"),t(\"td\",[s._v(\"热点参数限流的异常\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",[s._v(\"DegradeException\")]),s._v(\" \"),t(\"td\",[s._v(\"降级异常\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",[s._v(\"AuthorityException\")]),s._v(\" \"),t(\"td\",[s._v(\"授权规则异常\")])]),s._v(\" \"),t(\"tr\",[t(\"td\",[s._v(\"SystemBlockException\")]),s._v(\" \"),t(\"td\",[s._v(\"系统规则异常\")])])])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_4-2-2-自定义异常处理\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-2-2-自定义异常处理\"}},[s._v(\"#\")]),s._v(\" 4.2.2.自定义异常处理\")]),s._v(\" \"),t(\"p\",[s._v(\"下面，我们就在order-service定义一个自定义异常处理类：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"package\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"order\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"sentinel\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"com\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"alibaba\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"csp\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"sentinel\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"adapter\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"spring\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"webmvc\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"callback\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BlockExceptionHandler\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"com\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"alibaba\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"csp\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"sentinel\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"slots\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"block\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BlockException\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"com\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"alibaba\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"csp\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"sentinel\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"slots\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"block\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"authority\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AuthorityException\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"com\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"alibaba\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"csp\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"sentinel\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"slots\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"block\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"degrade\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"DegradeException\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"com\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"alibaba\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"csp\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"sentinel\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"slots\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"block\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"flow\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"FlowException\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"com\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"alibaba\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"csp\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"sentinel\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"slots\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"block\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"flow\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"param\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"ParamFlowException\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"org\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"springframework\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"stereotype\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Component\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"javax\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"servlet\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"http\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"HttpServletRequest\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"javax\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"servlet\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"http\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"HttpServletResponse\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Component\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"class\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"SentinelExceptionHandler\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"implements\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BlockExceptionHandler\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Override\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"void\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"handle\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"HttpServletRequest\")]),s._v(\" request\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"HttpServletResponse\")]),s._v(\" response\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BlockException\")]),s._v(\" e\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"throws\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Exception\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" msg \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"未知异常\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"int\")]),s._v(\" status \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"429\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"if\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"e \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"instanceof\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"FlowException\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n            msg \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"请求被限流了\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"else\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"if\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"e \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"instanceof\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"ParamFlowException\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n            msg \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"请求被热点参数限流\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"else\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"if\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"e \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"instanceof\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"DegradeException\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n            msg \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"请求被降级了\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"else\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"if\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"e \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"instanceof\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AuthorityException\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n            msg \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"没有权限访问\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n            status \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"401\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\n        response\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"setContentType\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"application/json;charset=utf-8\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        response\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"setStatus\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"status\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        response\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"getWriter\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"println\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"{\\\\\"msg\\\\\": \"')]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"+\")]),s._v(\" msg \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"+\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\", \\\\\"status\\\\\": \"')]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"+\")]),s._v(\" status \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"+\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"}\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"17\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"18\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"19\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"20\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"21\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"22\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"23\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"24\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"25\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"26\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"27\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"28\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"29\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"30\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"31\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"32\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"33\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"34\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"35\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"36\")]),t(\"br\")])]),t(\"p\",[s._v(\"重启测试，在不同场景下，会返回不同的异常消息.\")]),s._v(\" \"),t(\"p\",[s._v(\"限流：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716154155238.png\",alt:\"image-20210716153938887\"}})]),s._v(\" \"),t(\"p\",[s._v(\"授权拦截时：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716153434095.png\",alt:\"image-20210716154012736\"}})]),s._v(\" \"),t(\"h1\",{attrs:{id:\"_5-规则持久化\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-规则持久化\"}},[s._v(\"#\")]),s._v(\" 5.规则持久化\")]),s._v(\" \"),t(\"p\",[s._v(\"现在，sentinel的所有规则都是内存存储，\"),t(\"strong\",[s._v(\"重启后所有规则都会丢失\")]),s._v(\"。\"),t(\"strong\",[s._v(\"在生产环境下，我们必须确保这些规则的持久化，避免丢失。\")])]),s._v(\" \"),t(\"h2\",{attrs:{id:\"_5-1-规则管理模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-1-规则管理模式\"}},[s._v(\"#\")]),s._v(\" 5.1.规则管理模式\")]),s._v(\" \"),t(\"p\",[s._v(\"规则是否能持久化，取决于规则管理模式，sentinel支持三种规则管理模式：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"原始模式：Sentinel的默认模式，将规则保存在内存，重启服务会丢失。\")]),s._v(\" \"),t(\"li\",[s._v(\"pull模式\")]),s._v(\" \"),t(\"li\",[s._v(\"push模式\")])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_5-1-1-pull模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-1-1-pull模式\"}},[s._v(\"#\")]),s._v(\" 5.1.1.pull模式\")]),s._v(\" \"),t(\"p\",[s._v(\"pull模式：控制台将配置的规则推送到Sentinel客户端，而客户端会将配置规则保存在本地文件或数据库中。以后会定时去本地文件或数据库中查询，更新本地规则。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/1533829307389.png\",alt:\"image-20210716154155238\"}})]),s._v(\" \"),t(\"h3\",{attrs:{id:\"_5-1-2-push模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-1-2-push模式\"}},[s._v(\"#\")]),s._v(\" 5.1.2.push模式\")]),s._v(\" \"),t(\"p\",[s._v(\"push模式：控制台将配置规则推送到远程配置中心，例如Nacos。Sentinel客户端监听Nacos，获取配置变更的推送消息，完成本地配置更新。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210716154012736.png\",alt:\"image-20210716154215456\"}})]),s._v(\" \"),t(\"h1\",{attrs:{id:\"总结\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#总结\"}},[s._v(\"#\")]),s._v(\" 总结\")]),s._v(\" \"),t(\"p\",[s._v(\"sentinel能做啥\")]),s._v(\" \"),t(\"p\",[s._v(\"来之前的流量控制    配置好簇点链路  通过dashboard控制台\")]),s._v(\" \"),t(\"p\",[s._v(\"出问题后的隔离和降级    整合feign   编写自定义异常    以及4.2中的自定义异常\")]),s._v(\" \"),t(\"p\",[s._v(\"隔离的话  线程池隔离（dashboard控制台）  信号量隔离（默认是这种   但好像没讲到？）\")]),s._v(\" \"),t(\"p\",[s._v(\"降级    状态机   三种状态    定义各种的调用失败\")]),s._v(\" \"),t(\"p\",[s._v(\"然后最后将规则持久化（这里也没细讲   整合nacos）\")])])}),[],!1,null,null,null);t.default=e.exports}}]);","extractedComments":[]}