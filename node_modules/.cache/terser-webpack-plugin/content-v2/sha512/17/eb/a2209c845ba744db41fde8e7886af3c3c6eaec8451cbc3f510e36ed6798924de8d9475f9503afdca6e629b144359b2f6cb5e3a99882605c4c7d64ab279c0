{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[71],{401:function(s,t,a){\"use strict\";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":s.$parent.slotKey}},[t(\"h1\",{attrs:{id:\"分布式事务\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#分布式事务\"}},[s._v(\"#\")]),s._v(\" 分布式事务\")]),s._v(\" \"),t(\"p\",[s._v(\"本地事务，也就是传统的\"),t(\"strong\",[s._v(\"单机事务\")]),s._v(\"。在传统数据库事务中，必须要满足四个原则：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724165045186.png\",alt:\"image-20210724165045186\"}})]),s._v(\" \"),t(\"p\",[t(\"code\",[s._v(\"隔离性\")]),s._v(\"：加各种锁\")]),s._v(\" \"),t(\"p\",[t(\"code\",[s._v(\"持久性\")]),s._v(\"：日志管理\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"分布式事务\")]),s._v(\"，就是指不是在单个服务或单个数据库架构下，产生的事务，例如：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"跨数据源的分布式事务\")]),s._v(\" \"),t(\"li\",[s._v(\"跨服务的分布式事务\")]),s._v(\" \"),t(\"li\",[s._v(\"综合情况\")])]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"跨JVM进程产生分布式事务。\")])]),s._v(\" \"),t(\"p\",[s._v(\"需要通过不同的数据库链接去操作数据，此时产生分布式事务。 简言之：\"),t(\"strong\",[s._v(\"跨数据库实例产生分布式事务。\")])]),s._v(\" \"),t(\"p\",[s._v(\"在数据库水平拆分、服务垂直拆分之后，一个业务操作通常要跨多个数据库、服务才能完成。例如电商行业中比较常见的下单付款案例，包括下面几个行为：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"创建新订单\")]),s._v(\" \"),t(\"li\",[s._v(\"扣减商品库存\")]),s._v(\" \"),t(\"li\",[s._v(\"从用户账户余额扣除金额\")])]),s._v(\" \"),t(\"p\",[s._v(\"完成上面的操作需要访问三个不同的微服务和三个不同的数据库。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724165338958.png\",alt:\"image-20210724165338958\"}})]),s._v(\" \"),t(\"p\",[s._v(\"订单的创建、库存的扣减、账户扣款在每一个服务和数据库内是一个本地事务，可以保证ACID原则。\")]),s._v(\" \"),t(\"p\",[s._v('但是当我们把三件事情看做一个\"业务\"，要满足保证“业务”的原子性，要么所有操作全部成功，要么全部失败，不允许出现部分成功部分失败的现象，这就是'),t(\"strong\",[s._v(\"分布式系统下的事务\")]),s._v(\"了。\")]),s._v(\" \"),t(\"p\",[s._v(\"此时ACID难以满足，这是分布式事务要解决的问题\")]),s._v(\" \"),t(\"p\",[s._v(\"微服务结构如下：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724165729273.png\",alt:\"image-20210724165729273\"}})]),s._v(\" \"),t(\"p\",[s._v(\"其中：\")]),s._v(\" \"),t(\"p\",[s._v(\"seata-demo：父工程，负责管理项目依赖\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"account-service：账户服务，负责管理用户的资金账户。提供扣减余额的接口\")]),s._v(\" \"),t(\"li\",[s._v(\"storage-service：库存服务，负责管理商品库存。提供扣减库存的接口\")]),s._v(\" \"),t(\"li\",[s._v(\"order-service：订单服务，负责管理订单。创建订单时，需要调用account-service和storage-service\")])]),s._v(\" \"),t(\"p\",[s._v(\"启动nacos、所有微服务\")]),s._v(\" \"),t(\"p\",[s._v(\"测试下单功能，发出Post请求：\")]),s._v(\" \"),t(\"p\",[s._v(\"请求如下：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-sh line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-sh\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"curl\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"--location\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token parameter variable\"}},[s._v(\"--request\")]),s._v(\" POST \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v(\"'http://localhost:8082/order?userId=user202103032042012&commodityCode=100202003032041&count=20&money=200'\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\")])]),t(\"p\",[s._v(\"如图：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724170113404.png\",alt:\"image-20210724170113404\"}})]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"测试发现，当库存不足时，如果余额已经扣减，并不会回滚，出现了分布式事务问题。\")])]),s._v(\" \"),t(\"h2\",{attrs:{id:\"分布式事务理论\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#分布式事务理论\"}},[s._v(\"#\")]),s._v(\" 分布式事务理论\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"cap定理\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#cap定理\"}},[s._v(\"#\")]),s._v(\" CAP定理\")]),s._v(\" \"),t(\"p\",[s._v(\"1998年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有三个指标。\")]),s._v(\" \"),t(\"blockquote\",[t(\"ul\",[t(\"li\",[s._v(\"Consistency（一致性）\")]),s._v(\" \"),t(\"li\",[s._v(\"Availability（可用性）\")]),s._v(\" \"),t(\"li\",[s._v(\"Partition tolerance （分区容错性）\")])])]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724170735847.png\",alt:\"image-20210724170517944\"}})]),s._v(\" \"),t(\"p\",[s._v(\"Eric Brewer 说，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"一致性\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#一致性\"}},[s._v(\"#\")]),s._v(\" 一致性\")]),s._v(\" \"),t(\"p\",[s._v(\"Consistency（一致性）：用户访问分布式系统中的\"),t(\"strong\",[s._v(\"任意节点\")]),s._v(\"，\"),t(\"strong\",[s._v(\"得到的数据必须一致。\")])]),s._v(\" \"),t(\"p\",[s._v(\"比如现在包含两个节点，其中的初始数据是一致的：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724170517944.png\",alt:\"image-20210724170704694\"}})]),s._v(\" \"),t(\"p\",[s._v(\"当我们修改其中一个节点的数据时，两者的数据产生了差异：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724170704694.png\",alt:\"image-20210724170735847\"}})]),s._v(\" \"),t(\"p\",[s._v(\"要想保住一致性，就必须实现node01 到 node02的\"),t(\"strong\",[s._v(\"数据 同步\")]),s._v(\"：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724170932072.png\",alt:\"image-20210724170834855\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"可用性\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#可用性\"}},[s._v(\"#\")]),s._v(\" 可用性\")]),s._v(\" \"),t(\"p\",[s._v(\"Availability （可用性）：用户访问集群中的\"),t(\"strong\",[s._v(\"任意健康节点，必须能得到响应，而不是超时或拒绝\")]),s._v(\"。\")]),s._v(\" \"),t(\"p\",[s._v(\"如图，有三个节点的集群，访问任何一个都可以及时得到响应：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724171007516.png\",alt:\"image-20210724170932072\"}})]),s._v(\" \"),t(\"p\",[s._v(\"当有部分节点因为网络故障或其它原因无法访问时，代表节点不可用：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724170834855.png\",alt:\"image-20210724171007516\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"分区容错\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#分区容错\"}},[s._v(\"#\")]),s._v(\" 分区容错\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"Partition（分区）\")]),s._v(\"：因为\"),t(\"strong\",[s._v(\"网络故障或其它原因\")]),s._v(\"导致分布式系统中的部分节点与其它节点\"),t(\"strong\",[s._v(\"失去连接，形成独立分区。\")])]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724172123567.png\",alt:\"image-20210724171041210\"}})]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"Tolerance（容错）\")]),s._v(\"：在集群出现分区时，整个系统也要持续对外提供服务\")]),s._v(\" \"),t(\"p\",[s._v(\"在分布式系统中，系统间的网络不能100%保证健康，一定会有故障的时候，而服务有必须对外保证服务。因此\"),t(\"strong\",[s._v(\"Partition Tolerance不可避免。****（P必存在  且必须解决）\")])]),s._v(\" \"),t(\"p\",[s._v(\"当节点接收到新的数据变更时，就会出现问题了：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724171041210.png\",alt:\"image-20210724171546472\"}})]),s._v(\" \"),t(\"p\",[s._v(\"如果此时要保证\"),t(\"strong\",[s._v(\"一致性\")]),s._v(\"，就必须等待网络恢复，完成数据同步后，整个集群才对外提供服务，服务处于阻塞状态，不可用。\")]),s._v(\" \"),t(\"p\",[s._v(\"如果此时要保证\"),t(\"strong\",[s._v(\"可用性\")]),s._v(\"，就不能等待网络恢复，那node01、node02与node03之间就会出现数据不一致。\")]),s._v(\" \"),t(\"p\",[s._v(\"也就是说，\"),t(\"strong\",[s._v(\"在P一定会出现的情况下，A和C之间只能实现一个。\")])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"base理论\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#base理论\"}},[s._v(\"#\")]),s._v(\" BASE理论\")]),s._v(\" \"),t(\"p\",[s._v(\"BASE理论是对CAP的一种解决思路，包含三个思想：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"strong\",[s._v(\"Basically Available\")]),s._v(\" \"),t(\"strong\",[s._v(\"（基本可用）\")]),s._v(\"：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用。\")]),s._v(\" \"),t(\"li\",[s._v(\"**Soft State（软状态）：**在一定时间内，允许出现中间状态，比如临时的不一致状态。\")]),s._v(\" \"),t(\"li\",[t(\"strong\",[s._v(\"Eventually Consistent（最终一致性）\")]),s._v(\"：虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致。\")])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"解决分布式事务的思路\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#解决分布式事务的思路\"}},[s._v(\"#\")]),s._v(\" 解决分布式事务的思路\")]),s._v(\" \"),t(\"p\",[s._v(\"分布式事务最大的问题是各个子事务的一致性问题，因此可以借鉴CAP定理和BASE理论，有两种解决思路：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"AP模式：各子事务分别执行和提交，允许出现结果不一致，然后采用弥补措施恢复数据即可，实现最终一致。\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[s._v(\"CP模式：各个子事务执行后互相等待，同时提交，同时回滚，达成强一致。但事务等待过程中，处于弱可用状态。\")])])]),s._v(\" \"),t(\"p\",[s._v(\"但不管是哪一种模式，\"),t(\"strong\",[s._v(\"都需要在子系统事务之间互相通讯，协调事务状态\")]),s._v(\"，也就是需要一个\"),t(\"strong\",[s._v(\"事务协调者(TC)\")]),s._v(\"：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724172326452.png\",alt:\"image-20210724172123567\"}})]),s._v(\" \"),t(\"p\",[s._v(\"这里的子系统事务，称为\"),t(\"strong\",[s._v(\"分支事务\")]),s._v(\"；有关联的各个分支事务在一起称为\"),t(\"strong\",[s._v(\"全局事务\")]),s._v(\"。\")]),s._v(\" \"),t(\"h2\",{attrs:{id:\"seata\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#seata\"}},[s._v(\"#\")]),s._v(\" Seata\")]),s._v(\" \"),t(\"p\",[s._v(\"Seata是 2019 年 1 月份蚂蚁金服和阿里巴巴共同开源的分布式事务解决方案。致力于提供高性能和简单易用的分布式事务服务，为用户打造一站式的分布式解决方案。\")]),s._v(\" \"),t(\"p\",[s._v(\"官网地址：http://seata.io/\")]),s._v(\" \"),t(\"p\",[s._v(\"Seata事务管理中有三个重要的角色：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"TC (Transaction Coordinator) -\")]),s._v(\" **事务协调者：**维护全局和分支事务的状态，\"),t(\"strong\",[s._v(\"协调全局事务提交或回滚。\")])])]),s._v(\" \"),t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"TM (Transaction Manager) -\")]),s._v(\" **事务管理器：**\"),t(\"strong\",[s._v(\"定义全局事务的范围、开始全局事务、提交或回滚全局事务\")]),s._v(\"。\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"RM (Resource Manager) -\")]),s._v(\" \"),t(\"strong\",[s._v(\"资源管理器：\"),t(\"strong\",[s._v(\"管理分支事务处理的资源，与TC交谈以注册分支事务和报告\")]),s._v(\"分支事务\")]),s._v(\"的状态，并驱动分支事务提交或回滚。\")])])]),s._v(\" \"),t(\"p\",[s._v(\"整体的架构如图：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724171546472.png\",alt:\"image-20210724172326452\"}})]),s._v(\" \"),t(\"p\",[s._v(\"Seata基于上述架构提供了四种不同的分布式事务解决方案：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"XA模式：强一致性分阶段事务模式，牺牲了一定的可用性，无业务侵入\")]),s._v(\" \"),t(\"li\",[s._v(\"TCC模式：最终一致的分阶段事务模式，有业务侵入\")]),s._v(\" \"),t(\"li\",[s._v(\"AT模式：最终一致的分阶段事务模式，无业务侵入，也是Seata的默认模式\")]),s._v(\" \"),t(\"li\",[s._v(\"SAGA模式：长事务模式，有业务侵入\")])]),s._v(\" \"),t(\"p\",[s._v(\"无论哪种方案，都离不开TC，也就是事务的协调者。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"部署tc服务\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#部署tc服务\"}},[s._v(\"#\")]),s._v(\" 部署TC服务\")]),s._v(\" \"),t(\"p\",[s._v(\"TC事务协调者本质上是个服务  需要部署安装后面才能用\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"微服务集成seata\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#微服务集成seata\"}},[s._v(\"#\")]),s._v(\" 微服务集成Seata\")]),s._v(\" \"),t(\"p\",[s._v(\"我们以order-service为例来演示。\")]),s._v(\" \"),t(\"h5\",{attrs:{id:\"引入依赖\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#引入依赖\"}},[s._v(\"#\")]),s._v(\" 引入依赖\")]),s._v(\" \"),t(\"p\",[s._v(\"首先，在order-service中引入依赖：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-xml line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-xml\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"\\x3c!--seata--\\x3e\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"dependency\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"groupId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"com.alibaba.cloud\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"groupId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"artifactId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"spring-cloud-starter-alibaba-seata\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"artifactId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"exclusions\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"\\x3c!--版本较低，1.3.0，因此排除--\\x3e\")]),s._v(\" \\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"exclusion\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n            \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"artifactId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"seata-spring-boot-starter\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"artifactId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n            \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"groupId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"io.seata\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"groupId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"exclusion\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"exclusions\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"dependency\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"dependency\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"groupId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"io.seata\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"groupId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"artifactId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"seata-spring-boot-starter\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"artifactId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"\\x3c!--seata starter 采用1.4.2版本--\\x3e\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"<\")]),s._v(\"version\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"${seata.version}\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"version\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"</\")]),s._v(\"dependency\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\">\")])]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"17\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"18\")]),t(\"br\")])]),t(\"h5\",{attrs:{id:\"配置tc地址\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#配置tc地址\"}},[s._v(\"#\")]),s._v(\" 配置TC地址\")]),s._v(\" \"),t(\"p\",[s._v(\"在order-service中的application.yml中，配置TC服务信息，\"),t(\"strong\",[s._v(\"通过注册中心nacos，结合服务名称获取TC地址\")]),s._v(\"：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-yaml line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"seata\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"registry\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# TC服务注册中心的配置，微服务根据这些信息去注册中心获取tc服务地址\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"type\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" nacos \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 注册中心类型 nacos\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"nacos\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"server-addr\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" 127.0.0.1\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"8848\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# nacos地址\")]),s._v(\"\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"namespace\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"\"')]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# namespace，默认为空\")]),s._v(\"\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"group\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" DEFAULT_GROUP \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 分组，默认是DEFAULT_GROUP\")]),s._v(\"\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"application\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" seata\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"tc\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"server \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# seata服务名称\")]),s._v(\"\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"username\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" nacos\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"password\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" nacos\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"tx-service-group\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" seata\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"-\")]),s._v(\"demo \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 事务组名称\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"service\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"vgroup-mapping\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 事务组与cluster的映射关系\")]),s._v(\"\\n      \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"seata-demo\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" SH\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\")])]),t(\"p\",[s._v(\"微服务如何根据这些配置寻找TC的地址呢？\")]),s._v(\" \"),t(\"p\",[s._v(\"我们知道注册到Nacos中的微服务，确定一个具体实例需要四个信息：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"namespace：命名空间\")]),s._v(\" \"),t(\"li\",[s._v(\"group：分组\")]),s._v(\" \"),t(\"li\",[s._v(\"application：服务名\")]),s._v(\" \"),t(\"li\",[s._v(\"cluster：集群名\")])]),s._v(\" \"),t(\"p\",[s._v(\"以上四个信息，在刚才的yaml文件中都能找到：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724174234987.png\",alt:\"image-20210724173654258\"}})]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"namespace为空，就是默认的public\")])]),s._v(\" \"),t(\"p\",[s._v(\"结合起来，TC服务的信息就是：public@DEFAULT_GROUP@seata-tc-server@SH，这样就能确定TC服务集群了。然后就可以去Nacos拉取对应的实例信息了。\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"xa模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#xa模式\"}},[s._v(\"#\")]),s._v(\" XA模式\")]),s._v(\" \"),t(\"p\",[s._v(\"XA 规范 是 X/Open 组织定义的分布式事务处理（DTP，Distributed Transaction Processing）标准，XA 规范 描述了全局的TM与局部的RM之间的接口，\"),t(\"strong\",[s._v(\"几乎所有主流的数据库都对 XA 规范 提供了支持。 （基本上数据库都实现了RM）\")])]),s._v(\" \"),t(\"h4\",{attrs:{id:\"两阶段提交\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#两阶段提交\"}},[s._v(\"#\")]),s._v(\" 两阶段提交\")]),s._v(\" \"),t(\"p\",[s._v(\"XA是规范，目前主流数据库都实现了这种规范，实现的原理都是基于两阶段提交**（2PC  下面的准备 指的是业务的执行）**。\")]),s._v(\" \"),t(\"p\",[s._v(\"正常情况：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724174102768.png\",alt:\"image-20210724174102768\"}})]),s._v(\" \"),t(\"p\",[s._v(\"异常情况：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724173654258.png\",alt:\"image-20210724174234987\"}})]),s._v(\" \"),t(\"p\",[s._v(\"一阶段：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"事务协调者通知每个事物参与者执行本地事务\")]),s._v(\" \"),t(\"li\",[s._v(\"本地事务执行完成后报告事务执行状态给事务协调者，\"),t(\"strong\",[s._v(\"此时事务不提交，继续持有数据库锁\")])])]),s._v(\" \"),t(\"p\",[s._v(\"二阶段：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"事务协调者基于一阶段的报告来判断下一步操作\\n\"),t(\"ul\",[t(\"li\",[s._v(\"如果一阶段都成功，则通知所有事务参与者，提交事务\")]),s._v(\" \"),t(\"li\",[s._v(\"如果一阶段任意一个参与者失败，\"),t(\"strong\",[s._v(\"则通知所有事务参与者回滚事务\")])])])])]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"(强一致性)\")])]),s._v(\" \"),t(\"h4\",{attrs:{id:\"seata的xa模型\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#seata的xa模型\"}},[s._v(\"#\")]),s._v(\" Seata的XA模型\")]),s._v(\" \"),t(\"p\",[s._v(\"Seata对原始的XA模式做了简单的封装和改造，以适应自己的事务模型，基本架构如图：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724175327511.png\",alt:\"image-20210724174424070\"}})]),s._v(\" \"),t(\"p\",[s._v(\"RM一阶段的工作：\")]),s._v(\" \"),t(\"p\",[s._v(\"​\\t① \"),t(\"strong\",[s._v(\"注册分支事务到TC\")])]),s._v(\" \"),t(\"p\",[s._v(\"​\\t② \"),t(\"strong\",[s._v(\"执行分支业务sql但不提交\")])]),s._v(\" \"),t(\"p\",[s._v(\"​\\t③ 报告执行状态到TC\")]),s._v(\" \"),t(\"p\",[s._v(\"TC二阶段的工作：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[s._v(\"TC检测各分支事务执行状态\")]),s._v(\" \"),t(\"p\",[s._v(\"a.如果都成功，通知所有RM提交事务\")]),s._v(\" \"),t(\"p\",[s._v(\"b.如果有失败，通知所有RM回滚事务\")])])]),s._v(\" \"),t(\"p\",[s._v(\"RM二阶段的工作：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"接收TC指令，提交或回滚事务\")])]),s._v(\" \"),t(\"h4\",{attrs:{id:\"实现xa模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#实现xa模式\"}},[s._v(\"#\")]),s._v(\" 实现XA模式\")]),s._v(\" \"),t(\"p\",[s._v(\"Seata的starter已经完成了XA模式的自动装配，实现非常简单，步骤如下：\")]),s._v(\" \"),t(\"p\",[s._v(\"1）修改application.yml文件（每个参与事务的微服务），开启XA模式：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-yaml line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"seata\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"data-source-proxy-mode\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" XA\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\")])]),t(\"p\",[s._v(\"2）\"),t(\"strong\",[s._v(\"给发起全局事务的入口方法添加@GlobalTransactional注解:\")])]),s._v(\" \"),t(\"p\",[s._v(\"本例中是OrderServiceImpl中的create方法.\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724174859556.png\",alt:\"image-20210724174859556\"}})]),s._v(\" \"),t(\"p\",[s._v(\"3）重启服务并测试\")]),s._v(\" \"),t(\"p\",[s._v(\"重启order-service，再次测试，发现无论怎样，三个微服务都能成功回滚。\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"总结\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#总结\"}},[s._v(\"#\")]),s._v(\" 总结\")]),s._v(\" \"),t(\"p\",[s._v(\"XA模式的原理:2PC\")]),s._v(\" \"),t(\"p\",[s._v(\"XA模式的优点是什么？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"strong\",[s._v(\"事务的强一致性，满足ACID原则。\")])]),s._v(\" \"),t(\"li\",[s._v(\"常用数据库都支持，实现简单，并且没有代码侵入\")])]),s._v(\" \"),t(\"p\",[s._v(\"XA模式的缺点是什么？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"因为\"),t(\"strong\",[s._v(\"一阶段需要锁定数据库资源，等待二阶段结束才释放，性能较差\")])]),s._v(\" \"),t(\"li\",[t(\"strong\",[s._v(\"依赖关系型数据库实现事务\")])])]),s._v(\" \"),t(\"p\",[s._v(\"如何操作：\")]),s._v(\" \"),t(\"ol\",[t(\"li\",[s._v(\"配置TC服务\")]),s._v(\" \"),t(\"li\",[s._v(\"yaml文件修改\")]),s._v(\" \"),t(\"li\",[s._v(\"在全局事务调用的方法中加注解\"),t(\"code\",[s._v(\"GlobalTransactional\")])])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"at模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#at模式\"}},[s._v(\"#\")]),s._v(\" AT模式\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"原理\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#原理\"}},[s._v(\"#\")]),s._v(\" 原理\")]),s._v(\" \"),t(\"p\",[s._v(\"AT模式同样是分阶段提交的事务模型，不过缺弥补了XA模型中资源锁定周期过长的缺陷。\")]),s._v(\" \"),t(\"p\",[s._v(\"基本流程图：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724174424070.png\",alt:\"image-20210724175327511\"}})]),s._v(\" \"),t(\"p\",[s._v(\"阶段一RM的工作：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"注册分支事务\")]),s._v(\" \"),t(\"li\",[s._v(\"记录\"),t(\"strong\",[s._v(\"undo-log（数据快照）\")])]),s._v(\" \"),t(\"li\",[s._v(\"执行业务sql并提交\")]),s._v(\" \"),t(\"li\",[s._v(\"报告事务状态\")])]),s._v(\" \"),t(\"p\",[s._v(\"阶段二提交时RM的工作：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"删除undo-log即可\")])]),s._v(\" \"),t(\"p\",[s._v(\"阶段二回滚时RM的工作：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"根据undo-log恢复数据到更新前\")])]),s._v(\" \"),t(\"p\",[s._v(\"比如，现在又一个数据库表，记录用户余额：\")]),s._v(\" \"),t(\"table\",[t(\"thead\",[t(\"tr\",[t(\"th\",[t(\"strong\",[s._v(\"id\")])]),s._v(\" \"),t(\"th\",[t(\"strong\",[s._v(\"money\")])])])]),s._v(\" \"),t(\"tbody\",[t(\"tr\",[t(\"td\",[s._v(\"1\")]),s._v(\" \"),t(\"td\",[s._v(\"100\")])])])]),s._v(\" \"),t(\"p\",[s._v(\"其中一个分支业务要执行的SQL为：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-sql line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-sql\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"update\")]),s._v(\" tb_account \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"set\")]),s._v(\" money \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" money \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"-\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"10\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"where\")]),s._v(\" id \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\")])]),t(\"p\",[s._v(\"AT模式下，当前分支事务执行流程如下：\")]),s._v(\" \"),t(\"p\",[s._v(\"一阶段：\")]),s._v(\" \"),t(\"p\",[s._v(\"1）TM发起并注册全局事务到TC\")]),s._v(\" \"),t(\"p\",[s._v(\"2）TM调用分支事务\")]),s._v(\" \"),t(\"p\",[s._v(\"3）分支事务准备执行业务SQL\")]),s._v(\" \"),t(\"p\",[s._v(\"4）RM拦截业务SQL，根据where条件查询原始数据，形成快照。\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-json line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-json\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token property\"}},[s._v('\"id\"')]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\":\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token property\"}},[s._v('\"money\"')]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\":\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"100\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\")])]),t(\"p\",[s._v(\"5）RM执行业务SQL，提交本地事务，释放数据库锁。此时 \"),t(\"code\",[s._v(\"money = 90\")])]),s._v(\" \"),t(\"p\",[s._v(\"6）RM报告本地事务状态给TC\")]),s._v(\" \"),t(\"p\",[s._v(\"二阶段：\")]),s._v(\" \"),t(\"p\",[s._v(\"1）TM通知TC事务结束\")]),s._v(\" \"),t(\"p\",[s._v(\"2）TC检查分支事务状态\")]),s._v(\" \"),t(\"p\",[s._v(\"​\\t a）如果都成功，则立即删除快照\")]),s._v(\" \"),t(\"p\",[s._v(\"​\\t b）如果有分支事务失败，需要回滚。读取快照数据（\"),t(\"code\",[s._v('{\"id\": 1, \"money\": 100}')]),s._v(\"），将快照恢复到数据库。此时数据库再次恢复为100\")]),s._v(\" \"),t(\"p\",[s._v(\"流程图：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724180722921.png\",alt:\"image-20210724180722921\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"脏写问题\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#脏写问题\"}},[s._v(\"#\")]),s._v(\" 脏写问题\")]),s._v(\" \"),t(\"p\",[s._v(\"在多线程并发访问AT模式的分布式事务时，有可能出现脏写问题，如图：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724182217272.png\",alt:\"image-20210724181541234\"}})]),s._v(\" \"),t(\"p\",[s._v(\"丢失更新\")]),s._v(\" \"),t(\"p\",[s._v(\"为什么？\\n\"),t(\"strong\",[s._v(\"没有做到隔离\")])]),s._v(\" \"),t(\"p\",[s._v(\"解决思路就是引入了全局锁的概念。在释放DB锁之前，先拿到全局锁。避免同一时刻有另外一个事务来操作当前数据。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"同时尝试获取全局锁设置超时时间，超时释放手中的DB锁  避免死锁\")])]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724181541234.png\",alt:\"image-20230926092944599\"}})]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724182424907.png\",alt:\"image-20210724181843029\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"实现at模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#实现at模式\"}},[s._v(\"#\")]),s._v(\" 实现AT模式\")]),s._v(\" \"),t(\"p\",[s._v(\"AT模式中的快照生成、回滚等动作都是由框架自动完成，没有任何代码侵入，因此实现非常简单。\")]),s._v(\" \"),t(\"p\",[s._v(\"只不过，AT模式需要一个表来记录全局锁、另一张表来记录数据快照undo_log。\")]),s._v(\" \"),t(\"p\",[s._v(\"1）导入数据库表，记录全局锁\")]),s._v(\" \"),t(\"p\",[s._v(\"导入课前资料提供的Sql文件：seata-at.sql，其中lock_table导入到TC服务关联的数据库，undo_log表导入到微服务关联的数据库：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724182706011.png\",alt:\"image-20210724182217272\"}})]),s._v(\" \"),t(\"p\",[s._v(\"2）修改application.yml文件，将事务模式修改为AT模式即可：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-yaml line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"seata\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[s._v(\"data-source-proxy-mode\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\":\")]),s._v(\" AT \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# 默认就是AT\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\")])]),t(\"h4\",{attrs:{id:\"总结-2\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#总结-2\"}},[s._v(\"#\")]),s._v(\" 总结\")]),s._v(\" \"),t(\"p\",[s._v(\"简述AT模式与XA模式最大的区别是什么？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"XA模式一阶段不提交事务，锁定资源；AT模式一阶段直接提交，不锁定资源。\")]),s._v(\" \"),t(\"li\",[s._v(\"XA模式依赖数据库机制实现回滚；AT模式利用数据快照实现数据回滚。\")]),s._v(\" \"),t(\"li\",[s._v(\"XA模式强一致；AT模式最终一致\")])]),s._v(\" \"),t(\"p\",[s._v(\"AT模式的优点：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"一阶段完成直接提交事务，释放数据库资源，性能比较好\")]),s._v(\" \"),t(\"li\",[s._v(\"利用全局锁实现读写隔离\")]),s._v(\" \"),t(\"li\",[s._v(\"没有代码侵入，框架自动完成回滚和提交\")])]),s._v(\" \"),t(\"p\",[s._v(\"AT模式的缺点：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"两阶段之间属于软状态，属于最终一致\")]),s._v(\" \"),t(\"li\",[s._v(\"框架的快照功能会影响性能，但比XA模式要好很多\")])]),s._v(\" \"),t(\"h3\",{attrs:{id:\"tcc模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#tcc模式\"}},[s._v(\"#\")]),s._v(\" TCC模式\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"原理-2\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#原理-2\"}},[s._v(\"#\")]),s._v(\" 原理\")]),s._v(\" \"),t(\"p\",[s._v(\"TCC模式与AT模式非常相似，每阶段都是独立事务，不同的是\"),t(\"strong\",[s._v(\"TCC通过人工编码来实现数据恢复\")]),s._v(\"。需要实现三个方法：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"Try\")]),s._v(\"：资源的检测和预留；\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"Confirm\")]),s._v(\"：完成资源操作业务；要求 Try 成功 Confirm 一定要能成功。\")])]),s._v(\" \"),t(\"li\",[t(\"p\",[t(\"strong\",[s._v(\"Cancel\")]),s._v(\"：预留资源释放，可以理解为try的反向操作。\")])])]),s._v(\" \"),t(\"p\",[s._v(\"举例，一个扣减用户余额的业务。假设账户A原来余额是100，需要余额扣减30元。\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"strong\",[s._v(\"阶段一（ Try ）\")]),s._v(\"：检查余额是否充足，如果充足则冻结金额增加30元，可用余额扣除30\")])]),s._v(\" \"),t(\"p\",[s._v(\"初识余额：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724182457951.png\",alt:\"image-20210724182424907\"}})]),s._v(\" \"),t(\"p\",[s._v(\"余额充足，可以冻结：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724182810734.png\",alt:\"image-20210724182457951\"}})]),s._v(\" \"),t(\"p\",[s._v(\"此时，总金额 = 冻结金额 + 可用金额，数量依然是100不变。事务直接提交无需等待其它事务。\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"strong\",[s._v(\"阶段二（Confirm)\")]),s._v(\"：假如要提交（Confirm），则冻结金额扣减30\")])]),s._v(\" \"),t(\"p\",[s._v(\"确认可以提交，不过之前可用金额已经扣减过了，这里只要清除冻结金额就好了：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724181843029.png\",alt:\"image-20210724182706011\"}})]),s._v(\" \"),t(\"p\",[s._v(\"此时，总金额 = 冻结金额 + 可用金额 = 0 + 70  = 70元\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[t(\"strong\",[s._v(\"阶段二(Canncel)\")]),s._v(\"：如果要回滚（Cancel），则冻结金额扣减30，可用余额增加30\")])]),s._v(\" \"),t(\"p\",[s._v(\"需要回滚，那么就要释放冻结金额，恢复可用金额：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20230926092944599.png\",alt:\"image-20210724182810734\"}})]),s._v(\" \"),t(\"p\",[s._v(\"Seata中的TCC模型依然延续之前的事务架构，如图：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724184846396.png\",alt:\"image-20210724182937713\"}})]),s._v(\" \"),t(\"h4\",{attrs:{id:\"事务悬挂和空回滚\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#事务悬挂和空回滚\"}},[s._v(\"#\")]),s._v(\" 事务悬挂和空回滚\")]),s._v(\" \"),t(\"p\",[s._v(\"空回滚\")]),s._v(\" \"),t(\"p\",[s._v(\"当某分支事务的try阶段\"),t(\"strong\",[s._v(\"阻塞\")]),s._v(\"时，可能\"),t(\"strong\",[s._v(\"导致全局事务超时而触发二阶段的cancel操作\")]),s._v(\"。在\"),t(\"strong\",[s._v(\"未执行try操作时先执行了cancel操作，这时cancel不能做回滚\")]),s._v(\"，就是\"),t(\"strong\",[s._v(\"空回滚\")]),s._v(\"。\")]),s._v(\" \"),t(\"p\",[s._v(\"如图：\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724183426891.png\",alt:\"image-20210724183426891\"}})]),s._v(\" \"),t(\"p\",[s._v(\"执行cancel操作时，应当判断try是否已经执行，如果尚未执行，则应该空回滚。\")]),s._v(\" \"),t(\"p\",[s._v(\"业务悬挂\")]),s._v(\" \"),t(\"p\",[s._v(\"对于已经空回滚的业务，之前被阻塞的try操作恢复，继续执行try，就永远不可能confirm或cancel ，事务一直处于中间状态，这就是\"),t(\"strong\",[s._v(\"业务悬挂\")]),s._v(\"。\")]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"执行try操作时，应当判断cancel是否已经执行过了，如果已经执行，应当阻止空回滚后的try操作，避免悬挂\")])]),s._v(\" \"),t(\"h4\",{attrs:{id:\"实现tcc模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#实现tcc模式\"}},[s._v(\"#\")]),s._v(\" 实现TCC模式\")]),s._v(\" \"),t(\"p\",[s._v(\"从上面的例子可以看出，因为TCC是通过人工编码的方式进行的，所以要设置其他的字段，就比如说上面还得引入冻结金额这个字段。有了引入，就有适不适合放不方便引入的情况，有些并不好适合用TCC\")]),s._v(\" \"),t(\"p\",[s._v(\"解决空回滚和业务悬挂问题，\"),t(\"strong\",[s._v(\"必须要记录当前事务状态，是在try、还是cancel\")])]),s._v(\" \"),t(\"p\",[s._v(\"这里我们定义一张表：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-sql line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-sql\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"CREATE\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"TABLE\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token identifier\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")]),s._v(\"account_freeze_tbl\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")])]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token identifier\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")]),s._v(\"xid\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")])]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"varchar\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"128\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"NOT\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token boolean\"}},[s._v(\"NULL\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token identifier\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")]),s._v(\"user_id\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")])]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"varchar\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"255\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"DEFAULT\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token boolean\"}},[s._v(\"NULL\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"COMMENT\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v(\"'用户id'\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token identifier\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")]),s._v(\"freeze_money\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")])]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"int\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"11\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"unsigned\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"DEFAULT\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v(\"'0'\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"COMMENT\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v(\"'冻结金额'\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token identifier\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")]),s._v(\"state\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")])]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"int\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"DEFAULT\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token boolean\"}},[s._v(\"NULL\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"COMMENT\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v(\"'事务状态，0:try，1:confirm，2:cancel'\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\"\\n  \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"PRIMARY\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"KEY\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token identifier\"}},[t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")]),s._v(\"xid\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"`\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"USING\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"BTREE\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"ENGINE\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"InnoDB\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"DEFAULT\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"CHARSET\")]),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"utf8 ROW_FORMAT\"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\"COMPACT\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\")])]),t(\"p\",[s._v(\"其中：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"xid：是全局事务id\")]),s._v(\" \"),t(\"li\",[s._v(\"freeze_money：用来记录用户冻结金额\")]),s._v(\" \"),t(\"li\",[s._v(\"state：用来记录事务状态\")])]),s._v(\" \"),t(\"p\",[s._v(\"那此时，我们的业务开怎么做呢？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"Try业务：\\n\"),t(\"ul\",[t(\"li\",[s._v(\"记录冻结金额和事务状态到account_freeze表\")]),s._v(\" \"),t(\"li\",[s._v(\"扣减account表可用金额\")])])]),s._v(\" \"),t(\"li\",[s._v(\"Confirm业务\\n\"),t(\"ul\",[t(\"li\",[s._v(\"根据xid删除account_freeze表的冻结记录\")])])]),s._v(\" \"),t(\"li\",[s._v(\"Cancel业务\\n\"),t(\"ul\",[t(\"li\",[s._v(\"修改account_freeze表，冻结金额为0，state为2\")]),s._v(\" \"),t(\"li\",[s._v(\"修改account表，恢复可用金额\")])])]),s._v(\" \"),t(\"li\",[s._v(\"如何判断是否空回滚？\\n\"),t(\"ul\",[t(\"li\",[t(\"strong\",[s._v(\"cancel业务中，根据xid查询account_freeze，如果为null则说明try还没做，需要空回滚\")])])])]),s._v(\" \"),t(\"li\",[s._v(\"如何避免业务悬挂？\\n\"),t(\"ul\",[t(\"li\",[t(\"strong\",[s._v(\"try业务中，根据xid查询account_freeze ，如果已经存在则证明Cancel已经执行，拒绝执行try业务\")])])])])]),s._v(\" \"),t(\"p\",[s._v(\"接下来，我们改造account-service，利用TCC实现余额扣减功能。\")]),s._v(\" \"),t(\"p\",[s._v(\"TCC的Try、Confirm、Cancel方法都需要在接口中基于注解来声明，\")]),s._v(\" \"),t(\"p\",[s._v(\"我们在account-service项目中的\"),t(\"code\",[s._v(\"cn.itcast.account.service\")]),s._v(\"包中新建一个接口，声明TCC三个接口：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"package\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"account\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"service\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"io\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"seata\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"rm\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"tcc\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"api\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BusinessActionContext\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"io\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"seata\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"rm\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"tcc\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"api\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BusinessActionContextParameter\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"io\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"seata\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"rm\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"tcc\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"api\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"LocalTCC\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"io\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"seata\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"rm\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"tcc\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"api\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"TwoPhaseBusinessAction\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@LocalTCC\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"interface\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"TCCService\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \\n \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"/**\\n * Try逻辑，@TwoPhaseBusinessAction中的name属性要与当前方法名一致，用于指定Try逻辑对应的方法\\n */\")]),s._v(\"\\n \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@TwoPhaseBusinessAction\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"name \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"prepare\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" commitMethod \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"confirm\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" rollbackMethod \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"cancel\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\"\\n \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"void\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"prepare\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@BusinessActionContextParameter\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"paramName \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"param\"')]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" param\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \\n \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"/**\\n * 二阶段confirm确认方法、可以另命名，但要保证与commitMethod一致\\n * @param context 上下文,可以传递try方法的参数\\n * @return boolean 执行是否成功\\n */\")]),s._v(\"\\n \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"boolean\")]),s._v(\" confirm \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BusinessActionContext\")]),s._v(\" context\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \\n \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"/**\\n * 二阶段回滚方法，要保证与rollbackMethod一致\\n */\")]),s._v(\"\\n \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"boolean\")]),s._v(\" cancel \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BusinessActionContext\")]),s._v(\" context\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"17\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"18\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"19\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"20\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"21\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"22\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"23\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"24\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"25\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"26\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"27\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"28\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"29\")]),t(\"br\")])]),t(\"p\",[s._v(\"在account-service服务中的\"),t(\"code\",[s._v(\"cn.itcast.account.service.impl\")]),s._v(\"包下新建一个类，实现TCC业务：\")]),s._v(\" \"),t(\"div\",{staticClass:\"language-java line-numbers-mode\"},[t(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[t(\"code\",[t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"package\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"account\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"service\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"impl\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"account\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"entity\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountFreeze\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"account\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"mapper\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountFreezeMapper\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"account\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"mapper\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountMapper\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"cn\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"itcast\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"account\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"service\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountTCCService\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"io\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"seata\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"core\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"context\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"RootContext\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"io\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"seata\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"rm\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"tcc\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"api\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BusinessActionContext\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"lombok\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"extern\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"slf4j\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Slf4j\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"org\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"springframework\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"beans\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"factory\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"annotation\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Autowired\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"org\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"springframework\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"stereotype\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Service\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"import\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token import\"}},[t(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[s._v(\"org\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"springframework\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"transaction\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"annotation\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")])]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Transactional\")])]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Service\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Slf4j\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"class\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountTCCServiceImpl\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"implements\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountTCCService\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Autowired\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"private\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountMapper\")]),s._v(\" accountMapper\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Autowired\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"private\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountFreezeMapper\")]),s._v(\" freezeMapper\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Override\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Transactional\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"void\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"deduct\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" userId\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"int\")]),s._v(\" money\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 0.获取事务id\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" xid \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"RootContext\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"getXID\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 判断freeze中是否有cancel记录  有的话就不能执行try了\")]),s._v(\"\\n        \\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 1.扣减可用余额\")]),s._v(\"\\n        accountMapper\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"deduct\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"userId\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" money\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 2.记录冻结金额，事务状态\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountFreeze\")]),s._v(\" freeze \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"new\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountFreeze\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        freeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"setUserId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"userId\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        freeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"setFreezeMoney\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"money\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        freeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"setState\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountFreeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"State\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token constant\"}},[s._v(\"TRY\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\t\\t\"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 实体类static定义枚举  回去看看\")]),s._v(\"\\n        freeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"setXid\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"xid\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        freezeMapper\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"insert\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"freeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Override\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"boolean\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"confirm\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BusinessActionContext\")]),s._v(\" ctx\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 1.获取事务id\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" xid \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" ctx\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"getXid\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 2.根据id删除冻结记录\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"int\")]),s._v(\" count \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" freezeMapper\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"deleteById\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"xid\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" count \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"==\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[s._v(\"@Override\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"public\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"boolean\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"cancel\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"BusinessActionContext\")]),s._v(\" ctx\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 0.查询冻结记录\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"String\")]),s._v(\" xid \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" ctx\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"getXid\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountFreeze\")]),s._v(\" freeze \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" freezeMapper\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"selectById\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"xid\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\\t\\t\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 回滚要判断try有没有执行是不是要进行空回滚吧   用state判断\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"if\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"freeze \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"==\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"null\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n            \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 空回滚...\")]),s._v(\"\\n                \\n            \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token boolean\"}},[s._v(\"true\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n        \\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 幂等性  判断是否执行过cancel了\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 通过状态字段判断\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"if\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n            \\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n            \\n            \\n            \\n            \\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 1.恢复可用余额\")]),s._v(\"\\n        accountMapper\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"refund\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"freeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"getUserId\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" freeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"getFreezeMoney\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// 2.将冻结金额清零，状态改为CANCEL\")]),s._v(\"\\n        freeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"setFreezeMoney\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"0\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        freeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"setState\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),t(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"AccountFreeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"State\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token constant\"}},[s._v(\"CANCEL\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"int\")]),s._v(\" count \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" freezeMapper\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),t(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"updateById\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"freeze\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),t(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"return\")]),s._v(\" count \"),t(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"==\")]),s._v(\" \"),t(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n    \"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\"),t(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\")])]),s._v(\" \"),t(\"div\",{staticClass:\"line-numbers-wrapper\"},[t(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"13\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"14\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"15\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"16\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"17\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"18\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"19\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"20\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"21\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"22\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"23\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"24\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"25\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"26\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"27\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"28\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"29\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"30\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"31\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"32\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"33\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"34\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"35\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"36\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"37\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"38\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"39\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"40\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"41\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"42\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"43\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"44\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"45\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"46\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"47\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"48\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"49\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"50\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"51\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"52\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"53\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"54\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"55\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"56\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"57\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"58\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"59\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"60\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"61\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"62\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"63\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"64\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"65\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"66\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"67\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"68\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"69\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"70\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"71\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"72\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"73\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"74\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"75\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"76\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"77\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"78\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"79\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"80\")]),t(\"br\"),t(\"span\",{staticClass:\"line-number\"},[s._v(\"81\")]),t(\"br\")])]),t(\"h4\",{attrs:{id:\"总结-3\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#总结-3\"}},[s._v(\"#\")]),s._v(\" 总结\")]),s._v(\" \"),t(\"p\",[s._v(\"TCC模式的每个阶段是做什么的？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"Try：资源检查和预留\")]),s._v(\" \"),t(\"li\",[s._v(\"Confirm：业务执行和提交\")]),s._v(\" \"),t(\"li\",[s._v(\"Cancel：预留资源的释放\")])]),s._v(\" \"),t(\"p\",[s._v(\"TCC的优点是什么？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"一阶段完成直接提交事务，释放数据库资源，性能好\")]),s._v(\" \"),t(\"li\",[s._v(\"相比AT模型，无需生成快照，无需使用全局锁，性能最强\")]),s._v(\" \"),t(\"li\",[s._v(\"不依赖数据库事务，而是依赖补偿操作，可以用于非事务型数据库\")])]),s._v(\" \"),t(\"p\",[s._v(\"TCC的缺点是什么？\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"有代码侵入，需要人为编写try、Confirm和Cancel接口，太麻烦\")]),s._v(\" \"),t(\"li\",[s._v(\"软状态，事务是最终一致\")]),s._v(\" \"),t(\"li\",[t(\"strong\",[s._v(\"需要考虑Confirm和Cancel的失败情况，做好幂等处理\")])])]),s._v(\" \"),t(\"p\",[s._v(\"字段的设计、适不适合引入TCC，状态字段、空回滚业务悬挂、\")]),s._v(\" \"),t(\"p\",[s._v(\"实现\"),t(\"code\",[s._v(\"LocalTcc\")]),s._v(\"注解   重写\"),t(\"code\",[s._v(\"try\")]),s._v(\" \"),t(\"code\",[s._v(\"@TwoPhaseBusinessAction\")]),s._v(\"， \"),t(\"code\",[s._v(\"confirm\")]),s._v(\" \"),t(\"code\",[s._v(\"cancel\")]),s._v(\"三个方法\")]),s._v(\" \"),t(\"p\",[t(\"code\",[s._v(\"BusinessActionContext\")]),s._v(\"上下文\")]),s._v(\" \"),t(\"h3\",{attrs:{id:\"saga模式\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#saga模式\"}},[s._v(\"#\")]),s._v(\" SAGA模式\")]),s._v(\" \"),t(\"p\",[s._v(\"Saga 模式是 Seata 即将开源的长事务解决方案，将由蚂蚁金服主要贡献。\")]),s._v(\" \"),t(\"p\",[s._v(\"其理论基础是Hector & Kenneth  在1987年发表的论文\"),t(\"a\",{attrs:{href:\"https://microservices.io/patterns/data/saga.html\",target:\"_blank\",rel:\"noopener noreferrer\"}},[s._v(\"Sagas\"),t(\"OutboundLink\")],1),s._v(\"。\")]),s._v(\" \"),t(\"p\",[s._v(\"Seata官网对于Saga的指南：https://seata.io/zh-cn/docs/user/saga.html\")]),s._v(\" \"),t(\"h4\",{attrs:{id:\"原理-3\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#原理-3\"}},[s._v(\"#\")]),s._v(\" 原理\")]),s._v(\" \"),t(\"p\",[s._v(\"在 Saga 模式下，分布式事务内有多个参与者，每一个参与者都是一个冲正补偿服务，需要用户根据业务场景实现其正向操作和逆向回滚操作。\")]),s._v(\" \"),t(\"p\",[s._v(\"分布式事务执行过程中，依次执行各参与者的正向操作，如果所有正向操作均执行成功，那么分布式事务提交。如果任何一个正向操作执行失败，那么分布式事务会去退回去执行前面各参与者的逆向回滚操作，回滚已提交的参与者，使分布式事务回到初始状态。\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724182937713.png\",alt:\"image-20210724184846396\"}})]),s._v(\" \"),t(\"p\",[s._v(\"Saga也分为两个阶段：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"一阶段：直接提交本地事务\")]),s._v(\" \"),t(\"li\",[s._v(\"二阶段：成功则什么都不做；失败则通过编写补偿业务来回滚\")])]),s._v(\" \"),t(\"p\",[s._v(\"优点：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"事务参与者可以基于事件驱动实现异步调用，吞吐高\")]),s._v(\" \"),t(\"li\",[s._v(\"一阶段直接提交事务，无锁，性能好\")]),s._v(\" \"),t(\"li\",[s._v(\"不用编写TCC中的三个阶段，实现简单\")])]),s._v(\" \"),t(\"p\",[s._v(\"缺点：\")]),s._v(\" \"),t(\"ul\",[t(\"li\",[s._v(\"软状态持续时间不确定，时效性差\")]),s._v(\" \"),t(\"li\",[s._v(\"没有锁，没有事务隔离，会有脏写\")])]),s._v(\" \"),t(\"h2\",{attrs:{id:\"总结-4\"}},[t(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#总结-4\"}},[s._v(\"#\")]),s._v(\" 总结\")]),s._v(\" \"),t(\"p\",[t(\"img\",{attrs:{src:\"https://czynotebook.oss-cn-beijing.aliyuncs.com/notebook/image-20210724185021819.png\",alt:\"image-20210724185021819\"}})]),s._v(\" \"),t(\"p\",[t(\"strong\",[s._v(\"在条件允许的情况下，我们尽可能选择本地事务单数据源\")]),s._v(\"，因为它减少了网络交互带来的性能损耗，且避免了数据 弱一致性带来的种种问题。\")]),s._v(\" \"),t(\"p\",[s._v(\"若某系统频繁且不合理的使用分布式事务，应首先从整体设计角度观察\"),t(\"strong\",[s._v(\"服务的拆分是否合理\")]),s._v(\"，是否高内聚低耦合？是否粒度太小？分布式事务一直是业界难题，因为网络的不确定性，而且我们习惯于拿 分布式事务与单机事务ACID做对比。 无论是数据库层的XA、还是应用层TCC、可靠消息、最大努力通知等方案，\"),t(\"strong\",[s._v(\"都没有完美解决分布式事务问题\")]),s._v(\"，它们 不过是各自在性能、一致性、可用性等方面做取舍，寻求某些场景偏好下的权衡\")])])}),[],!1,null,null,null);t.default=e.exports}}]);","extractedComments":[]}